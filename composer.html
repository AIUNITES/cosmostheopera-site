<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Music Composer Tool - COSMOS the OPERA</title>
  <meta name="description" content="Create sheet music from your words using AI-inspired composition methods, VRN notation, and multiple musical styles.">
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ¼</text></svg>">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg-dark: #0a0a0f;
      --bg-card: #12121a;
      --bg-input: #1a1a24;
      --text-primary: #ffffff;
      --text-secondary: #a0a0b0;
      --accent-purple: #9d4edd;
      --accent-cyan: #00d4ff;
      --accent-gold: #ffd700;
      --accent-pink: #ff6b9d;
      --accent-green: #00ff88;
    }
    body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg-dark); color: var(--text-primary); line-height: 1.6; min-height: 100vh; }
    
    /* Navigation */
    .nav { background: var(--bg-card); padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); position: sticky; top: 0; z-index: 100; }
    .nav-logo { font-size: 1.5rem; font-weight: 800; color: var(--accent-gold); text-decoration: none; }
    .nav-links { display: flex; gap: 25px; flex-wrap: wrap; }
    .nav-links a { color: var(--text-secondary); text-decoration: none; font-size: 0.95rem; transition: color 0.3s; }
    .nav-links a:hover, .nav-links a.active { color: var(--accent-cyan); }
    
    /* Hero */
    .hero { padding: 40px 20px; text-align: center; background: linear-gradient(135deg, rgba(157,78,221,0.15), rgba(0,212,255,0.1)); }
    .hero h1 { font-size: clamp(1.8rem, 4vw, 2.5rem); margin-bottom: 10px; background: linear-gradient(135deg, #fff, var(--accent-gold)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .hero p { color: var(--text-secondary); max-width: 700px; margin: 0 auto; }
    
    /* Main Layout */
    .composer-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; max-width: 1600px; margin: 0 auto; padding: 20px; min-height: calc(100vh - 200px); }
    @media (max-width: 1024px) { .composer-container { grid-template-columns: 1fr; } }
    
    /* Panel Styles */
    .panel { background: var(--bg-card); border-radius: 15px; border: 1px solid rgba(255,255,255,0.1); overflow: hidden; display: flex; flex-direction: column; }
    .panel-header { background: rgba(157,78,221,0.2); padding: 15px 20px; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .panel-header h2 { font-size: 1.2rem; color: var(--accent-gold); display: flex; align-items: center; gap: 10px; }
    .panel-content { padding: 20px; flex: 1; overflow-y: auto; }
    
    /* Input Panel */
    .lyrics-input { width: 100%; min-height: 150px; background: var(--bg-input); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; padding: 15px; color: var(--text-primary); font-family: inherit; font-size: 1rem; resize: vertical; margin-bottom: 20px; }
    .lyrics-input:focus { outline: none; border-color: var(--accent-cyan); }
    .lyrics-input::placeholder { color: var(--text-secondary); }
    
    /* Options Sections */
    .options-section { margin-bottom: 25px; }
    .options-section h3 { font-size: 1rem; color: var(--accent-cyan); margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
    .options-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; }
    .options-list { display: flex; flex-direction: column; gap: 8px; }
    
    /* Checkbox/Radio Styles */
    .option-item { display: flex; align-items: center; gap: 10px; padding: 10px 15px; background: var(--bg-input); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; cursor: pointer; transition: all 0.3s; font-size: 0.9rem; }
    .option-item:hover { border-color: var(--accent-purple); background: rgba(157,78,221,0.1); }
    .option-item input { display: none; }
    .option-item.selected { border-color: var(--accent-green); background: rgba(0,255,136,0.1); }
    .option-item .icon { font-size: 1.2rem; }
    .option-item .label { flex: 1; }
    .option-item .check { width: 18px; height: 18px; border: 2px solid var(--text-secondary); border-radius: 4px; display: flex; align-items: center; justify-content: center; transition: all 0.3s; }
    .option-item.selected .check { border-color: var(--accent-green); background: var(--accent-green); }
    .option-item.selected .check::after { content: 'âœ“'; color: #000; font-size: 12px; font-weight: bold; }
    .option-radio .check { border-radius: 50%; }
    .option-radio.selected .check::after { content: ''; width: 8px; height: 8px; background: #000; border-radius: 50%; }
    
    /* Select Dropdowns */
    .select-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
    .select-group { display: flex; flex-direction: column; gap: 5px; }
    .select-group label { font-size: 0.85rem; color: var(--text-secondary); }
    .select-group select { background: var(--bg-input); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 10px 15px; color: var(--text-primary); font-size: 0.9rem; cursor: pointer; }
    .select-group select:focus { outline: none; border-color: var(--accent-cyan); }
    
    /* Generate Button */
    .generate-btn { width: 100%; padding: 15px 30px; background: linear-gradient(135deg, var(--accent-purple), var(--accent-pink)); border: none; border-radius: 10px; color: #fff; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 20px; }
    .generate-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(157,78,221,0.4); }
    .generate-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    
    /* Output Panel */
    .output-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
    .output-actions { display: flex; gap: 10px; }
    .output-btn { background: rgba(0,212,255,0.2); border: 1px solid var(--accent-cyan); color: var(--accent-cyan); padding: 6px 14px; border-radius: 15px; cursor: pointer; font-size: 0.85rem; transition: all 0.3s; }
    .output-btn:hover { background: rgba(0,212,255,0.3); }
    
    .score-output { background: var(--bg-input); border-radius: 10px; padding: 20px; font-family: 'Courier New', monospace; font-size: 11px; line-height: 1.4; white-space: pre; overflow-x: auto; min-height: 400px; color: var(--text-secondary); border: 1px solid rgba(255,255,255,0.05); }
    .score-output .highlight { color: var(--accent-gold); }
    .score-output .vrn { color: var(--accent-green); }
    .score-output .dynamics { color: var(--accent-pink); }
    .score-output .lyrics { color: var(--accent-cyan); }
    
    /* Tabs */
    .output-tabs { display: flex; gap: 5px; margin-bottom: 15px; flex-wrap: wrap; }
    .tab-btn { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: var(--text-secondary); padding: 8px 16px; border-radius: 8px 8px 0 0; cursor: pointer; font-size: 0.85rem; transition: all 0.3s; }
    .tab-btn:hover { background: rgba(255,255,255,0.1); }
    .tab-btn.active { background: var(--bg-input); border-bottom-color: var(--bg-input); color: var(--accent-gold); }
    
    /* Footer */
    .footer { background: var(--bg-card); padding: 20px; text-align: center; border-top: 1px solid rgba(255,255,255,0.05); }
    .footer p { color: var(--text-secondary); font-size: 0.85rem; }
    .footer a { color: var(--accent-purple); text-decoration: none; }
    
    /* Responsive */
    @media (max-width: 768px) {
      .nav { flex-direction: column; gap: 15px; }
      .options-grid { grid-template-columns: 1fr 1fr; }
      .select-row { grid-template-columns: 1fr; }
      .score-output { font-size: 9px; }
    }
  </style>
</head>
<body>
  <nav class="nav">
    <a href="index.html" class="nav-logo">ğŸŒŒ COSMOS</a>
    <div class="nav-links">
      <a href="index.html">Home</a>
      <a href="notation.html">Vocal Notation</a>
      <a href="composition.html">AI Composition</a>
      <a href="gallery.html">Hubble Gallery</a>
      <a href="sheet-music.html">Sheet Music</a>
      <a href="words.html">Words</a>
      <a href="composer.html" class="active">Composer</a>
    </div>
  </nav>

  <header class="hero">
    <h1>ğŸ¼ Music Composer Tool</h1>
    <p>Transform your words into sheet music using AI-inspired composition methods, Vocal Resonance Notation, and multiple musical styles.</p>
  </header>

  <div class="composer-container">
    <!-- Input Panel -->
    <div class="panel">
      <div class="panel-header">
        <h2>âœï¸ Your Words & Options</h2>
      </div>
      <div class="panel-content">
        <textarea class="lyrics-input" id="lyricsInput" placeholder="Enter your lyrics or words here...

Example:
do you see
what do you see
when you close your eyes
i see the light
an infinite number of stars"></textarea>

        <!-- Notation Format -->
        <div class="options-section">
          <h3>ğŸ“‹ Notation Format</h3>
          <div class="options-grid" id="notationOptions">
            <label class="option-item option-radio selected" data-value="satb">
              <span class="icon">ğŸ¼</span>
              <span class="label">SATB Staff</span>
              <span class="check"></span>
            </label>
            <label class="option-item option-radio" data-value="ssaattbb">
              <span class="icon">ğŸ­</span>
              <span class="label">SSAATTBB</span>
              <span class="check"></span>
            </label>
            <label class="option-item option-radio" data-value="treble-bass">
              <span class="icon">ğŸ¹</span>
              <span class="label">Treble/Bass</span>
              <span class="check"></span>
            </label>
            <label class="option-item option-radio" data-value="lead-sheet">
              <span class="icon">ğŸ“„</span>
              <span class="label">Lead Sheet</span>
              <span class="check"></span>
            </label>
          </div>
        </div>

        <!-- Dynamics Notation -->
        <div class="options-section">
          <h3>ğŸ”Š Dynamics & Expression</h3>
          <div class="options-grid" id="dynamicsOptions">
            <label class="option-item selected" data-value="traditional">
              <span class="icon">ğŸµ</span>
              <span class="label">Traditional (pp-ff)</span>
              <span class="check"></span>
            </label>
            <label class="option-item selected" data-value="vrn">
              <span class="icon">ğŸ—£ï¸</span>
              <span class="label">VRN Codes</span>
              <span class="check"></span>
            </label>
            <label class="option-item" data-value="expressive">
              <span class="icon">ğŸ’«</span>
              <span class="label">Expressive Text</span>
              <span class="check"></span>
            </label>
          </div>
        </div>

        <!-- Musical Style -->
        <div class="options-section">
          <h3>ğŸ¨ Musical Style</h3>
          <div class="options-grid" id="styleOptions">
            <label class="option-item option-radio selected" data-value="operatic">
              <span class="icon">ğŸ­</span>
              <span class="label">Operatic</span>
              <span class="check"></span>
            </label>
            <label class="option-item option-radio" data-value="hypnotic">
              <span class="icon">ğŸŒ€</span>
              <span class="label">Hypnotic</span>
              <span class="check"></span>
            </label>
            <label class="option-item option-radio" data-value="trance">
              <span class="icon">âœ¨</span>
              <span class="label">Trance</span>
              <span class="check"></span>
            </label>
            <label class="option-item option-radio" data-value="classical">
              <span class="icon">ğŸ›ï¸</span>
              <span class="label">Classical</span>
              <span class="check"></span>
            </label>
            <label class="option-item option-radio" data-value="jazz">
              <span class="icon">ğŸ·</span>
              <span class="label">Jazz</span>
              <span class="check"></span>
            </label>
            <label class="option-item option-radio" data-value="rock">
              <span class="icon">ğŸ¸</span>
              <span class="label">Rock</span>
              <span class="check"></span>
            </label>
            <label class="option-item option-radio" data-value="folk">
              <span class="icon">ğŸª•</span>
              <span class="label">Folk</span>
              <span class="check"></span>
            </label>
            <label class="option-item option-radio" data-value="ambient">
              <span class="icon">ğŸŒŠ</span>
              <span class="label">Ambient</span>
              <span class="check"></span>
            </label>
          </div>
        </div>

        <!-- Musical Parameters -->
        <div class="options-section">
          <h3>âš™ï¸ Musical Parameters</h3>
          <div class="select-row">
            <div class="select-group">
              <label>Key Signature</label>
              <select id="keySelect">
                <option value="C">C Major</option>
                <option value="G">G Major</option>
                <option value="D">D Major</option>
                <option value="A">A Major</option>
                <option value="E">E Major</option>
                <option value="F">F Major</option>
                <option value="Bb">Bâ™­ Major</option>
                <option value="Eb">Eâ™­ Major</option>
                <option value="Am">A Minor</option>
                <option value="Em">E Minor</option>
                <option value="Dm">D Minor</option>
              </select>
            </div>
            <div class="select-group">
              <label>Time Signature</label>
              <select id="timeSelect">
                <option value="4/4">4/4 (Common)</option>
                <option value="3/4">3/4 (Waltz)</option>
                <option value="6/8">6/8 (Compound)</option>
                <option value="2/4">2/4 (March)</option>
                <option value="5/4">5/4 (Irregular)</option>
              </select>
            </div>
          </div>
          <div class="select-row">
            <div class="select-group">
              <label>Tempo</label>
              <select id="tempoSelect">
                <option value="60">Largo (60 BPM)</option>
                <option value="72" selected>Andante (72 BPM)</option>
                <option value="90">Moderato (90 BPM)</option>
                <option value="120">Allegro (120 BPM)</option>
                <option value="140">Vivace (140 BPM)</option>
              </select>
            </div>
            <div class="select-group">
              <label>Voice Type</label>
              <select id="voiceSelect">
                <option value="soprano">Soprano</option>
                <option value="mezzo" selected>Mezzo-Soprano</option>
                <option value="alto">Alto</option>
                <option value="tenor">Tenor</option>
                <option value="baritone">Baritone</option>
                <option value="bass">Bass</option>
              </select>
            </div>
          </div>
        </div>

        <button class="generate-btn" id="generateBtn" onclick="generateScore()">
          <span>ğŸµ</span> Generate Sheet Music
        </button>
      </div>
    </div>

    <!-- Output Panel -->
    <div class="panel">
      <div class="panel-header">
        <div class="output-header">
          <h2>ğŸ“œ Generated Score</h2>
          <div class="output-actions">
            <button class="output-btn" onclick="copyScore()">ğŸ“‹ Copy</button>
            <button class="output-btn" onclick="downloadScore()">ğŸ’¾ Download</button>
          </div>
        </div>
      </div>
      <div class="panel-content">
        <div class="output-tabs">
          <button class="tab-btn active" data-tab="score" onclick="switchTab('score')">Score</button>
          <button class="tab-btn" data-tab="vrn" onclick="switchTab('vrn')">VRN Guide</button>
          <button class="tab-btn" data-tab="analysis" onclick="switchTab('analysis')">Analysis</button>
        </div>
        <div class="score-output" id="scoreOutput">
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                        ğŸ¼ COSMOS MUSIC COMPOSER                                â•‘
â•‘                                                                                â•‘
â•‘  Enter your lyrics in the text box on the left, choose your notation format,  â•‘
â•‘  dynamics style, and musical genre, then click "Generate Sheet Music"         â•‘
â•‘                                                                                â•‘
â•‘  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â•‘
â•‘                                                                                â•‘
â•‘  NOTATION FORMATS:                                                             â•‘
â•‘  â€¢ SATB Staff - Traditional choral notation with staff lines                   â•‘
â•‘  â€¢ SSAATTBB - 8-part chorus with arrow notation                                â•‘
â•‘  â€¢ Treble/Bass - Piano-style grand staff notation                              â•‘
â•‘  â€¢ Lead Sheet - Melody with chord symbols                                      â•‘
â•‘                                                                                â•‘
â•‘  DYNAMICS OPTIONS:                                                             â•‘
â•‘  â€¢ Traditional - pp, p, mp, mf, f, ff, fff                                     â•‘
â•‘  â€¢ VRN Codes - [C], [H], [M], [N], [O] with intensity levels                   â•‘
â•‘  â€¢ Expressive - Written descriptions (tender, powerful, ethereal)              â•‘
â•‘                                                                                â•‘
â•‘  MUSICAL STYLES:                                                               â•‘
â•‘  â€¢ Operatic - Dramatic, wide intervals, emotional climaxes                     â•‘
â•‘  â€¢ Hypnotic - Repetitive patterns, trance-inducing                             â•‘
â•‘  â€¢ Trance - Building intensity, euphoric peaks                                 â•‘
â•‘  â€¢ Classical - Balanced phrases, traditional harmonies                         â•‘
â•‘  â€¢ Jazz - Chromatic movement, extended chords                                  â•‘
â•‘  â€¢ Rock - Strong rhythms, pentatonic melodies                                  â•‘
â•‘  â€¢ Folk - Simple, singable, modal inflections                                  â•‘
â•‘  â€¢ Ambient - Sustained tones, atmospheric textures                             â•‘
â•‘                                                                                â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</div>
      </div>
    </div>
  </div>

  <footer class="footer">
    <p>Â© 2002-2026 COSMOS the OPERA. All Rights Reserved. DMCA Protected.<br>
    <a href="index.html">Home</a> | <a href="composition.html">AI Composition Guide</a> | <a href="notation.html">VRN Guide</a></p>
  </footer>

  <script>
// Option selection handling
document.querySelectorAll('.option-item').forEach(item => {
  item.addEventListener('click', function() {
    const parent = this.parentElement;
    const isRadio = this.classList.contains('option-radio');
    
    if (isRadio) {
      parent.querySelectorAll('.option-item').forEach(i => i.classList.remove('selected'));
      this.classList.add('selected');
    } else {
      this.classList.toggle('selected');
    }
  });
});

// Get selected options
function getSelectedOptions(containerId) {
  const container = document.getElementById(containerId);
  const selected = container.querySelectorAll('.option-item.selected');
  return [...selected].map(item => item.dataset.value);
}

function getSelectedRadio(containerId) {
  const container = document.getElementById(containerId);
  const selected = container.querySelector('.option-item.selected');
  return selected ? selected.dataset.value : null;
}

// Voice ranges
const voiceRanges = {
  soprano: { low: 'C4', high: 'C6', mid: 'A4', scale: ['C4','D4','E4','F4','G4','A4','B4','C5','D5','E5','F5','G5','A5','B5','C6'] },
  mezzo: { low: 'A3', high: 'A5', mid: 'E4', scale: ['A3','B3','C4','D4','E4','F4','G4','A4','B4','C5','D5','E5','F5','G5','A5'] },
  alto: { low: 'F3', high: 'F5', mid: 'C4', scale: ['F3','G3','A3','B3','C4','D4','E4','F4','G4','A4','B4','C5','D5','E5','F5'] },
  tenor: { low: 'C3', high: 'C5', mid: 'G3', scale: ['C3','D3','E3','F3','G3','A3','B3','C4','D4','E4','F4','G4','A4','B4','C5'] },
  baritone: { low: 'A2', high: 'A4', mid: 'E3', scale: ['A2','B2','C3','D3','E3','F3','G3','A3','B3','C4','D4','E4','F4','G4','A4'] },
  bass: { low: 'E2', high: 'E4', mid: 'B2', scale: ['E2','F2','G2','A2','B2','C3','D3','E3','F3','G3','A3','B3','C4','D4','E4'] }
};

// Style characteristics
const stylePatterns = {
  operatic: { intervals: [2,3,4,5,7], buildUp: true, climax: true, dynamics: ['p','mp','mf','f','ff','fff'] },
  hypnotic: { intervals: [1,2,3], buildUp: false, climax: false, dynamics: ['p','mp','mf'], repetitive: true },
  trance: { intervals: [2,3,5], buildUp: true, climax: true, dynamics: ['p','mf','f','ff'], pulse: true },
  classical: { intervals: [2,3,4,5], buildUp: true, climax: true, dynamics: ['p','mp','mf','f'] },
  jazz: { intervals: [1,2,3,4,6,7], buildUp: false, climax: false, dynamics: ['mp','mf','f'], chromatic: true },
  rock: { intervals: [2,3,5,7], buildUp: true, climax: true, dynamics: ['mf','f','ff'], pentatonic: true },
  folk: { intervals: [2,3,5], buildUp: false, climax: false, dynamics: ['mp','mf'], modal: true },
  ambient: { intervals: [2,5,7], buildUp: false, climax: false, dynamics: ['pp','p','mp'], sustained: true }
};

// VRN codes based on pitch and emotion
function getVRNCode(pitch, emotion, intensity) {
  const noteNum = parseInt(pitch.slice(-1));
  let code = '';
  
  if (noteNum <= 3) {
    code = 'C'; // Chest
  } else if (noteNum === 4) {
    code = emotion === 'powerful' ? 'CM' : 'M'; // Mix
  } else if (noteNum >= 5) {
    code = emotion === 'ethereal' ? 'H' : 'HM'; // Head
  }
  
  const plus = '+'.repeat(Math.min(3, intensity));
  return `[${code}${plus}]`;
}

// Parse lyrics into words/syllables
function parseLyrics(text) {
  const lines = text.trim().split('\n').filter(l => l.trim());
  const words = [];
  
  lines.forEach((line, lineIdx) => {
    const lineWords = line.trim().split(/\s+/);
    lineWords.forEach((word, wordIdx) => {
      if (word) {
        words.push({
          text: word.toLowerCase(),
          isLineStart: wordIdx === 0,
          isLineEnd: wordIdx === lineWords.length - 1,
          lineNum: lineIdx
        });
      }
    });
  });
  
  return words;
}

// Generate melodic contour
function generateMelody(words, voice, style) {
  const range = voiceRanges[voice];
  const pattern = stylePatterns[style];
  const melody = [];
  
  let currentIdx = Math.floor(range.scale.length / 2);
  const totalWords = words.length;
  
  words.forEach((word, i) => {
    const progress = i / totalWords;
    const emotion = progress > 0.7 ? 'powerful' : (progress < 0.3 ? 'tender' : 'building');
    const intensity = Math.ceil(progress * 3);
    
    // Determine interval
    let interval = pattern.intervals[Math.floor(Math.random() * pattern.intervals.length)];
    let direction = Math.random() > 0.5 ? 1 : -1;
    
    // Build toward climax
    if (pattern.buildUp && progress > 0.5) {
      direction = 1;
      interval = Math.min(interval + 1, 5);
    }
    
    // Line start often lower, line end often sustained
    if (word.isLineStart && i > 0) {
      currentIdx = Math.max(currentIdx - 2, 2);
    }
    
    // Calculate new position
    currentIdx = Math.max(0, Math.min(range.scale.length - 1, currentIdx + (direction * interval)));
    
    // Climax peak
    if (pattern.climax && progress > 0.8 && progress < 0.9) {
      currentIdx = Math.min(currentIdx + 3, range.scale.length - 2);
    }
    
    const pitch = range.scale[currentIdx];
    const vrn = getVRNCode(pitch, emotion, intensity);
    const dynamic = pattern.dynamics[Math.min(Math.floor(progress * pattern.dynamics.length), pattern.dynamics.length - 1)];
    
    melody.push({
      word: word.text,
      pitch: pitch,
      vrn: vrn,
      dynamic: dynamic,
      duration: word.isLineEnd ? 2 : 1,
      isLineStart: word.isLineStart,
      isLineEnd: word.isLineEnd,
      lineNum: word.lineNum,
      emotion: emotion
    });
  });
  
  return melody;
}

// Generate SATB notation
function generateSATBNotation(melody, options) {
  const key = document.getElementById('keySelect').value;
  const time = document.getElementById('timeSelect').value;
  const tempo = document.getElementById('tempoSelect').value;
  const voice = document.getElementById('voiceSelect').value;
  const style = getSelectedRadio('styleOptions');
  const dynamics = getSelectedOptions('dynamicsOptions');
  
  let output = '';
  output += `â”Œ${'â”€'.repeat(78)}\n`;
  output += `â”‚  GENERATED SCORE\n`;
  output += `â”‚  Key: ${key}  Time: ${time}  Tempo: â™©=${tempo}  Voice: ${voice}\n`;
  output += `â”‚  Style: ${style}  Format: SATB Staff Notation\n`;
  output += `â”œ${'â”€'.repeat(78)}\n`;
  
  let measureNum = 1;
  let currentLine = -1;
  
  melody.forEach((note, i) => {
    if (note.lineNum !== currentLine) {
      currentLine = note.lineNum;
      output += `â”‚\n`;
      output += `â”‚  MEASURE ${measureNum}-${measureNum + 3}                                              ${note.dynamic}\n`;
      output += `â”‚${'â•'.repeat(78)}\n`;
      measureNum += 4;
    }
    
    // Create staff representation
    const pitchNum = parseInt(note.pitch.slice(-1));
    const pitchName = note.pitch;
    const staffLine = 6 - (pitchNum - 3);
    
    let staffStr = `â”‚  ${pitchName.padEnd(4)} `;
    for (let s = 0; s < 5; s++) {
      if (s === staffLine) {
        staffStr += `${'â”€'.repeat(10)}â—${'â”€'.repeat(10)}`;
      } else {
        staffStr += `${'â”€'.repeat(21)}`;
      }
    }
    output += staffStr + '\n';
    
    // Add text box with lyrics and VRN
    if (dynamics.includes('vrn')) {
      output += `â”‚       â•”${'â•'.repeat(60)}\n`;
      output += `â”‚       â•‘  ${note.vrn}  "${note.word}"\n`;
      output += `â”‚       â•š${'â•'.repeat(60)}\n`;
    } else {
      output += `â”‚       "${note.word}"\n`;
    }
    
    if (dynamics.includes('expressive') && note.isLineEnd) {
      output += `â”‚  Resonance: ${note.emotion}, ${note.duration > 1 ? 'sustained' : 'flowing'}\n`;
    }
  });
  
  output += `â””${'â”€'.repeat(78)}\n`;
  
  return output;
}

// Generate SSAATTBB notation
function generateSSAATTBBNotation(melody, options) {
  const key = document.getElementById('keySelect').value;
  const time = document.getElementById('timeSelect').value;
  const tempo = document.getElementById('tempoSelect').value;
  const style = getSelectedRadio('styleOptions');
  const dynamics = getSelectedOptions('dynamicsOptions');
  
  let output = '';
  output += `â”Œ${'â”€'.repeat(78)}\n`;
  output += `â”‚  SSAATTBB CHORAL SCORE                                                   \n`;
  output += `â”‚  Key: ${key}  Time: ${time}  Tempo: â™©=${tempo}  Style: ${style}\n`;
  output += `â”œ${'â”€'.repeat(78)}\n`;
  
  let measureNum = 1;
  let currentLine = -1;
  let lineNotes = [];
  
  melody.forEach((note, i) => {
    if (note.lineNum !== currentLine) {
      // Output previous line
      if (lineNotes.length > 0) {
        const pitchSeq = lineNotes.map(n => `â™©${n.pitch}`).join(' â”€â†’ ');
        const vrnSeq = dynamics.includes('vrn') ? lineNotes.map(n => n.vrn).join('') : '';
        const lyricsSeq = lineNotes.map(n => `"${n.word}"`).join('  ');
        const lastNote = lineNotes[lineNotes.length - 1];
        
        output += `â”‚  MEASURES ${measureNum}-${measureNum + 3}: ${lyricsSeq.substring(0, 40)}...    ${lastNote.dynamic}\n`;
        output += `â”‚  ${pitchSeq.substring(0, 70)}\n`;
        if (vrnSeq) {
          output += `â”‚  ${vrnSeq.substring(0, 70)}\n`;
        }
        output += `â”‚  SSAATTBB: Wave entry B2â†’S1, staggered                    ${lastNote.dynamic} ${lineNotes[0].vrn}\n`;
        output += `â”œ${'â”€'.repeat(78)}\n`;
        measureNum += 4;
      }
      
      currentLine = note.lineNum;
      lineNotes = [];
    }
    
    lineNotes.push(note);
  });
  
  // Output last line
  if (lineNotes.length > 0) {
    const pitchSeq = lineNotes.map(n => `â™©${n.pitch}`).join(' â”€â†’ ');
    const vrnSeq = dynamics.includes('vrn') ? lineNotes.map(n => n.vrn).join('') : '';
    const lyricsSeq = lineNotes.map(n => `"${n.word}"`).join('  ');
    const lastNote = lineNotes[lineNotes.length - 1];
    
    output += `â”‚  MEASURES ${measureNum}-${measureNum + 3}: ${lyricsSeq.substring(0, 40)}...    ${lastNote.dynamic} â˜… CLIMAX â˜…\n`;
    output += `â”‚  ${pitchSeq.substring(0, 60)} â—~~~~~~~~\n`;
    if (vrnSeq) {
      output += `â”‚  ${vrnSeq.substring(0, 70)}\n`;
    }
    output += `â”‚  SSAATTBB: Full 8-part texture, S1 descant                 fff ${lineNotes[0].vrn}\n`;
  }
  
  output += `â””${'â”€'.repeat(78)}\n`;
  
  return output;
}

// Generate Treble/Bass notation
function generateTrebleBassNotation(melody, options) {
  const key = document.getElementById('keySelect').value;
  const time = document.getElementById('timeSelect').value;
  const tempo = document.getElementById('tempoSelect').value;
  const dynamics = getSelectedOptions('dynamicsOptions');
  
  let output = '';
  output += `â•”${'â•'.repeat(78)}\n`;
  output += `â•‘  TREBLE/BASS CLEF NOTATION\n`;
  output += `â•‘  Key: ${key}  Time: ${time}  Tempo: â™©=${tempo}\n`;
  output += `â• ${'â•'.repeat(78)}\n`;
  
  let measureNum = 1;
  
  // Group by lines
  const lines = [];
  let currentLineNotes = [];
  let currentLineNum = -1;
  
  melody.forEach(note => {
    if (note.lineNum !== currentLineNum) {
      if (currentLineNotes.length > 0) {
        lines.push(currentLineNotes);
      }
      currentLineNotes = [];
      currentLineNum = note.lineNum;
    }
    currentLineNotes.push(note);
  });
  if (currentLineNotes.length > 0) {
    lines.push(currentLineNotes);
  }
  
  lines.forEach((lineNotes, lineIdx) => {
    output += `â•‘  Measure ${measureNum}                                              ${lineNotes[0].dynamic}\n`;
    output += `â•‘  ğ„ ${'â”€'.repeat(70)}\n`;
    
    // Treble staff
    for (let staff = 0; staff < 5; staff++) {
      let staffLine = `â•‘    `;
      lineNotes.forEach((note, i) => {
        const noteNum = parseInt(note.pitch.slice(-1));
        if (noteNum >= 4 && (5 - staff) === (noteNum - 3)) {
          staffLine += `â”€â”€â—â”€â”€`;
        } else {
          staffLine += `â”€â”€â”€â”€â”€`;
        }
      });
      output += staffLine + '\n';
    }
    
    // Lyrics line
    let lyricsLine = `â•‘    `;
    lineNotes.forEach(note => {
      lyricsLine += `"${note.word}" `;
    });
    output += lyricsLine + '\n';
    
    // VRN line
    if (dynamics.includes('vrn')) {
      let vrnLine = `â•‘    `;
      lineNotes.forEach(note => {
        vrnLine += note.vrn + ' ';
      });
      output += vrnLine + '\n';
    }
    
    output += `â•‘${'â”€'.repeat(78)}\n`;
    measureNum += 4;
  });
  
  output += `â•š${'â•'.repeat(78)}\n`;
  
  return output;
}

// Generate Lead Sheet notation
function generateLeadSheetNotation(melody, options) {
  const key = document.getElementById('keySelect').value;
  const time = document.getElementById('timeSelect').value;
  const tempo = document.getElementById('tempoSelect').value;
  const dynamics = getSelectedOptions('dynamicsOptions');
  
  // Chord progressions by key
  const chords = {
    'C': ['C', 'Am', 'F', 'G', 'Dm', 'Em'],
    'G': ['G', 'Em', 'C', 'D', 'Am', 'Bm'],
    'D': ['D', 'Bm', 'G', 'A', 'Em', 'F#m'],
    'A': ['A', 'F#m', 'D', 'E', 'Bm', 'C#m'],
    'E': ['E', 'C#m', 'A', 'B', 'F#m', 'G#m'],
    'F': ['F', 'Dm', 'Bb', 'C', 'Gm', 'Am'],
    'Bb': ['Bb', 'Gm', 'Eb', 'F', 'Cm', 'Dm'],
    'Eb': ['Eb', 'Cm', 'Ab', 'Bb', 'Fm', 'Gm'],
    'Am': ['Am', 'F', 'C', 'G', 'Dm', 'E'],
    'Em': ['Em', 'C', 'G', 'D', 'Am', 'B'],
    'Dm': ['Dm', 'Bb', 'F', 'C', 'Gm', 'A']
  };
  
  const keyChords = chords[key] || chords['C'];
  
  let output = '';
  output += `â•”${'â•'.repeat(70)}\n`;
  output += `â•‘  LEAD SHEET\n`;
  output += `â•‘  Key: ${key}  Time: ${time}  Tempo: â™©=${tempo}\n`;
  output += `â• ${'â•'.repeat(70)}\n`;
  
  let measureNum = 1;
  let currentLineNum = -1;
  let lineIdx = 0;
  
  melody.forEach((note, i) => {
    if (note.lineNum !== currentLineNum) {
      currentLineNum = note.lineNum;
      const chord = keyChords[lineIdx % keyChords.length];
      output += `â•‘\n`;
      output += `â•‘  [${chord}]                                            Measure ${measureNum}\n`;
      lineIdx++;
      measureNum += 2;
    }
    
    let noteLine = `â•‘    ${note.pitch}  ${note.word}`;
    if (dynamics.includes('traditional')) {
      noteLine += `  ${note.dynamic}`;
    }
    if (dynamics.includes('vrn')) {
      noteLine += `  ${note.vrn}`;
    }
    output += noteLine + '\n';
  });
  
  output += `â•š${'â•'.repeat(70)}\n`;
  
  return output;
}

// Main generate function
function generateScore() {
  const lyrics = document.getElementById('lyricsInput').value.trim();
  
  if (!lyrics) {
    alert('Please enter some lyrics or words to compose.');
    return;
  }
  
  const voice = document.getElementById('voiceSelect').value;
  const style = getSelectedRadio('styleOptions');
  const notation = getSelectedRadio('notationOptions');
  const dynamicsOpts = getSelectedOptions('dynamicsOptions');
  
  // Parse lyrics
  const words = parseLyrics(lyrics);
  
  if (words.length === 0) {
    alert('No valid words found in your lyrics.');
    return;
  }
  
  // Generate melody
  const melody = generateMelody(words, voice, style);
  
  // Generate notation based on format
  let output;
  switch (notation) {
    case 'satb':
      output = generateSATBNotation(melody, { dynamics: dynamicsOpts });
      break;
    case 'ssaattbb':
      output = generateSSAATTBBNotation(melody, { dynamics: dynamicsOpts });
      break;
    case 'treble-bass':
      output = generateTrebleBassNotation(melody, { dynamics: dynamicsOpts });
      break;
    case 'lead-sheet':
      output = generateLeadSheetNotation(melody, { dynamics: dynamicsOpts });
      break;
    default:
      output = generateSATBNotation(melody, { dynamics: dynamicsOpts });
  }
  
  document.getElementById('scoreOutput').textContent = output;
}

// Tab switching
function switchTab(tab) {
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.tab === tab);
  });
  
  const output = document.getElementById('scoreOutput');
  
  if (tab === 'vrn') {
    output.textContent = `
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    VOCAL RESONANCE NOTATION (VRN) GUIDE                      â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                              â•‘
â•‘  PRIMARY RESONANCE CODES:                                                    â•‘
â•‘  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                   â•‘
â•‘  [C]   = Chest Voice      Full chest resonance, grounded, powerful           â•‘
â•‘  [H]   = Head Voice       Upper resonance, light, ethereal                   â•‘
â•‘  [M]   = Mix Voice        Balanced chest/head, versatile                     â•‘
â•‘  [N]   = Nasal            Forward placement, bright, cutting                 â•‘
â•‘  [O]   = Oral             Open throat, warm, round                           â•‘
â•‘                                                                              â•‘
â•‘  INTENSITY LEVELS:                                                           â•‘
â•‘  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                           â•‘
â•‘  +     = Slight           Subtle activation                                  â•‘
â•‘  ++    = Moderate         Clear engagement                                   â•‘
â•‘  +++   = Maximum          Full intensity                                     â•‘
â•‘                                                                              â•‘
â•‘  MIXED DESIGNATIONS:                                                         â•‘
â•‘  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                        â•‘
â•‘  [CM]  = Chest-Mix        Chest-dominant mix                                 â•‘
â•‘  [HM]  = Head-Mix         Head-dominant mix                                  â•‘
â•‘                                                                              â•‘
â•‘  EXTENDED CODES:                                                             â•‘
â•‘  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                             â•‘
â•‘  [Ey+] = Eye Muscles      Mask resonance, "smiling" placement                â•‘
â•‘  [B+]  = Brow Muscles     Lifted placement for brightness                    â•‘
â•‘  [Oc+] = Occipital        Back-of-head resonance for fullness                â•‘
â•‘  [SP+] = Soft Palate      Raised palate for open sound                       â•‘
â•‘  [P+]  = Pharynx          Throat space, darker color                         â•‘
â•‘  [T+]  = Tongue           Tongue position affects resonance                  â•‘
â•‘  [L+]  = Larynx           Laryngeal position (high/low)                      â•‘
â•‘                                                                              â•‘
â•‘  EXAMPLE PROGRESSIONS:                                                       â•‘
â•‘  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                       â•‘
â•‘  Ascending phrase:    [C+] â†’ [CM] â†’ [M++] â†’ [HM] â†’ [H+++]                    â•‘
â•‘  Intimate opening:    [O++], [CM], [P+]                                      â•‘
â•‘  Powerful climax:     [H+++], [O+++], [Oc+++], [M+++]                        â•‘
â•‘  Ethereal moment:     [H], [N++], [SP+]                                      â•‘
â•‘                                                                              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`;
  } else if (tab === 'analysis') {
    const lyrics = document.getElementById('lyricsInput').value.trim();
    if (!lyrics) {
      output.textContent = `
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                           TEXT ANALYSIS                                      â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                              â•‘
â•‘  Enter lyrics in the input box and generate a score to see analysis.        â•‘
â•‘                                                                              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`;
    } else {
      const words = parseLyrics(lyrics);
      const lines = lyrics.split('\n').filter(l => l.trim());
      output.textContent = `
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                           TEXT ANALYSIS                                      â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                              â•‘
â•‘  Total Words:    ${words.length.toString().padEnd(56)}â•‘
â•‘  Total Lines:    ${lines.length.toString().padEnd(56)}â•‘
â•‘  Avg Words/Line: ${(words.length / lines.length).toFixed(1).padEnd(56)}â•‘
â•‘                                                                              â•‘
â•‘  EMOTIONAL ARC:                                                              â•‘
â•‘  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                               â•‘
â•‘  Opening:  Tender, questioning (suggested p - mp)                            â•‘
â•‘  Middle:   Building, developing (suggested mf - f)                           â•‘
â•‘  Climax:   Powerful, transcendent (suggested ff - fff)                       â•‘
â•‘  Close:    Resolving, fading (suggested mf - p)                              â•‘
â•‘                                                                              â•‘
â•‘  SUGGESTED VRN PROGRESSION:                                                  â•‘
â•‘  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                  â•‘
â•‘  0-30%:   [C+], [CM], [O++] - Grounded, intimate                             â•‘
â•‘  30-60%:  [M], [M++], [HM] - Building through middle voice                   â•‘
â•‘  60-85%:  [H++], [H+++], [N++] - Rising to climax                            â•‘
â•‘  85-100%: [H+++], [Oc+++] â†’ [M+] - Peak then resolution                      â•‘
â•‘                                                                              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`;
    }
  } else {
    // Keep current score output
  }
}

// Copy to clipboard
function copyScore() {
  const output = document.getElementById('scoreOutput').textContent;
  navigator.clipboard.writeText(output).then(() => {
    alert('Score copied to clipboard!');
  });
}

// Download as text file
function downloadScore() {
  const output = document.getElementById('scoreOutput').textContent;
  const blob = new Blob([output], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'cosmos-score.txt';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}
  </script>
</body>
</html>
