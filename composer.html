<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Music Composer Tool - COSMOS the OPERA</title>
  <meta name="description" content="Create sheet music from your words using AI-inspired composition methods, VRN notation, and multiple musical styles.">
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üéº</text></svg>">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg-dark: #0a0a0f;
      --bg-card: #12121a;
      --bg-input: #1a1a24;
      --text-primary: #ffffff;
      --text-secondary: #a0a0b0;
      --accent-purple: #9d4edd;
      --accent-cyan: #00d4ff;
      --accent-gold: #ffd700;
      --accent-pink: #ff6b9d;
      --accent-green: #00ff88;
    }
    body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg-dark); color: var(--text-primary); line-height: 1.6; min-height: 100vh; }
    
    /* Screen management */
    .screen { display: none; }
    .screen.active { display: block; }
    
    /* Navigation */
    .nav { background: var(--bg-card); padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); position: sticky; top: 0; z-index: 100; }
    .nav-logo { font-size: 1.5rem; font-weight: 800; color: var(--accent-gold); text-decoration: none; }
    .nav-links { display: flex; gap: 20px; flex-wrap: wrap; align-items: center; }
    .nav-links a { color: var(--text-secondary); text-decoration: none; font-size: 0.95rem; transition: color 0.3s; }
    .nav-links a:hover, .nav-links a.active { color: var(--accent-cyan); }
    .nav-btn { background: linear-gradient(135deg, var(--accent-purple), var(--accent-pink)); border: none; color: #fff; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 0.9rem; transition: all 0.3s; }
    .nav-btn:hover { transform: scale(1.05); }
    .nav-btn-secondary { background: transparent; border: 1px solid var(--accent-cyan); color: var(--accent-cyan); }
    
    /* User Menu */
    .user-menu { position: relative; display: flex; align-items: center; gap: 10px; cursor: pointer; }
    .user-avatar { width: 36px; height: 36px; background: linear-gradient(135deg, var(--accent-purple), var(--accent-cyan)); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; }
    .user-dropdown { position: absolute; top: 100%; right: 0; background: var(--bg-card); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; padding: 10px 0; min-width: 180px; display: none; z-index: 200; }
    .user-dropdown.show { display: block; }
    .user-dropdown a { display: block; padding: 10px 20px; color: var(--text-secondary); text-decoration: none; transition: all 0.3s; }
    .user-dropdown a:hover { background: rgba(255,255,255,0.05); color: var(--text-primary); }
    
    /* Hero */
    .hero { padding: 60px 20px; text-align: center; background: linear-gradient(135deg, rgba(157,78,221,0.15), rgba(0,212,255,0.1)); }
    .hero h1 { font-size: clamp(2rem, 5vw, 3rem); margin-bottom: 15px; background: linear-gradient(135deg, #fff, var(--accent-gold)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .hero p { color: var(--text-secondary); max-width: 700px; margin: 0 auto 30px; font-size: 1.1rem; }
    .hero-buttons { display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; }
    .btn-large { padding: 15px 30px; font-size: 1.1rem; border-radius: 30px; cursor: pointer; transition: all 0.3s; font-weight: 600; }
    .btn-primary { background: linear-gradient(135deg, var(--accent-purple), var(--accent-pink)); border: none; color: #fff; }
    .btn-primary:hover { transform: translateY(-3px); box-shadow: 0 10px 30px rgba(157,78,221,0.4); }
    .btn-secondary { background: transparent; border: 2px solid var(--accent-cyan); color: var(--accent-cyan); }
    .btn-secondary:hover { background: rgba(0,212,255,0.1); }
    
    /* Auth Screen */
    .auth-container { max-width: 400px; margin: 60px auto; padding: 20px; }
    .auth-header { text-align: center; margin-bottom: 30px; }
    .auth-header h2 { color: var(--accent-gold); margin-bottom: 10px; }
    .auth-tabs { display: flex; margin-bottom: 20px; }
    .auth-tab { flex: 1; padding: 12px; background: transparent; border: none; color: var(--text-secondary); cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.3s; }
    .auth-tab.active { color: var(--accent-cyan); border-bottom-color: var(--accent-cyan); }
    .auth-form { display: none; }
    .auth-form.active { display: block; }
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 0.9rem; }
    .form-group input { width: 100%; padding: 12px 15px; background: var(--bg-input); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: var(--text-primary); font-size: 1rem; }
    .form-group input:focus { outline: none; border-color: var(--accent-cyan); }
    .form-error { color: var(--accent-pink); font-size: 0.85rem; margin-bottom: 15px; }
    .full-width { width: 100%; }
    .auth-footer { text-align: center; margin-top: 20px; color: var(--text-secondary); font-size: 0.85rem; }
    .auth-footer a { color: var(--accent-cyan); text-decoration: none; }
    
    /* Dashboard */
    .dashboard-header { padding: 30px 20px; background: var(--bg-card); border-bottom: 1px solid rgba(255,255,255,0.1); }
    .dashboard-header h1 { font-size: 1.8rem; margin-bottom: 5px; }
    .dashboard-header p { color: var(--text-secondary); }
    .dashboard-content { max-width: 1400px; margin: 0 auto; padding: 30px 20px; }
    .dashboard-tabs { display: flex; gap: 10px; margin-bottom: 30px; flex-wrap: wrap; }
    .dash-tab { padding: 10px 20px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 25px; color: var(--text-secondary); cursor: pointer; transition: all 0.3s; }
    .dash-tab:hover { background: rgba(255,255,255,0.1); }
    .dash-tab.active { background: var(--accent-purple); border-color: var(--accent-purple); color: #fff; }
    
    /* Scores Grid */
    .scores-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
    .score-card { background: var(--bg-card); border-radius: 15px; border: 1px solid rgba(255,255,255,0.1); overflow: hidden; transition: all 0.3s; }
    .score-card:hover { border-color: var(--accent-purple); transform: translateY(-3px); }
    .score-card-header { padding: 20px; background: linear-gradient(135deg, rgba(157,78,221,0.2), rgba(0,212,255,0.1)); }
    .score-card-title { font-size: 1.1rem; margin-bottom: 5px; }
    .score-card-meta { display: flex; gap: 10px; flex-wrap: wrap; font-size: 0.8rem; color: var(--text-secondary); }
    .score-card-meta span { background: rgba(255,255,255,0.1); padding: 3px 10px; border-radius: 10px; }
    .score-card-body { padding: 15px 20px; }
    .score-card-preview { font-family: 'Courier New', monospace; font-size: 9px; color: var(--text-secondary); white-space: pre; overflow: hidden; max-height: 80px; line-height: 1.3; }
    .score-card-actions { padding: 15px 20px; border-top: 1px solid rgba(255,255,255,0.05); display: flex; gap: 10px; }
    .score-card-btn { flex: 1; padding: 8px; border-radius: 8px; border: none; cursor: pointer; font-size: 0.85rem; transition: all 0.3s; }
    .score-card-btn.primary { background: var(--accent-purple); color: #fff; }
    .score-card-btn.secondary { background: rgba(255,255,255,0.1); color: var(--text-secondary); }
    .score-card-btn:hover { opacity: 0.8; }
    
    /* Empty State */
    .empty-state { text-align: center; padding: 60px 20px; }
    .empty-state .icon { font-size: 4rem; margin-bottom: 20px; }
    .empty-state h3 { color: var(--text-secondary); margin-bottom: 10px; }
    .empty-state p { color: var(--text-secondary); margin-bottom: 20px; opacity: 0.7; }
    
    /* Composer Panel */
    .composer-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; max-width: 1600px; margin: 0 auto; padding: 20px; min-height: calc(100vh - 200px); }
    @media (max-width: 1024px) { .composer-container { grid-template-columns: 1fr; } }
    
    .panel { background: var(--bg-card); border-radius: 15px; border: 1px solid rgba(255,255,255,0.1); overflow: hidden; display: flex; flex-direction: column; }
    .panel-header { background: rgba(157,78,221,0.2); padding: 15px 20px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; }
    .panel-header h2 { font-size: 1.2rem; color: var(--accent-gold); display: flex; align-items: center; gap: 10px; }
    .panel-content { padding: 20px; flex: 1; overflow-y: auto; }
    
    .lyrics-input { width: 100%; min-height: 150px; background: var(--bg-input); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; padding: 15px; color: var(--text-primary); font-family: inherit; font-size: 1rem; resize: vertical; margin-bottom: 20px; }
    .lyrics-input:focus { outline: none; border-color: var(--accent-cyan); }
    .lyrics-input::placeholder { color: var(--text-secondary); }
    
    .options-section { margin-bottom: 25px; }
    .options-section h3 { font-size: 1rem; color: var(--accent-cyan); margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
    .options-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; }
    
    .option-item { display: flex; align-items: center; gap: 10px; padding: 10px 15px; background: var(--bg-input); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; cursor: pointer; transition: all 0.3s; font-size: 0.9rem; }
    .option-item:hover { border-color: var(--accent-purple); background: rgba(157,78,221,0.1); }
    .option-item.selected { border-color: var(--accent-green); background: rgba(0,255,136,0.1); }
    .option-item .icon { font-size: 1.2rem; }
    .option-item .label { flex: 1; }
    .option-item .check { width: 18px; height: 18px; border: 2px solid var(--text-secondary); border-radius: 4px; display: flex; align-items: center; justify-content: center; transition: all 0.3s; }
    .option-item.selected .check { border-color: var(--accent-green); background: var(--accent-green); }
    .option-item.selected .check::after { content: '‚úì'; color: #000; font-size: 12px; font-weight: bold; }
    .option-radio .check { border-radius: 50%; }
    .option-radio.selected .check::after { content: ''; width: 8px; height: 8px; background: #000; border-radius: 50%; }
    
    .select-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
    .select-group { display: flex; flex-direction: column; gap: 5px; }
    .select-group label { font-size: 0.85rem; color: var(--text-secondary); }
    .select-group select { background: var(--bg-input); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 10px 15px; color: var(--text-primary); font-size: 0.9rem; cursor: pointer; }
    .select-group select:focus { outline: none; border-color: var(--accent-cyan); }
    
    .generate-btn { width: 100%; padding: 15px 30px; background: linear-gradient(135deg, var(--accent-purple), var(--accent-pink)); border: none; border-radius: 10px; color: #fff; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 20px; }
    .generate-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(157,78,221,0.4); }
    
    .output-actions { display: flex; gap: 10px; }
    .output-btn { background: rgba(0,212,255,0.2); border: 1px solid var(--accent-cyan); color: var(--accent-cyan); padding: 6px 14px; border-radius: 15px; cursor: pointer; font-size: 0.85rem; transition: all 0.3s; }
    .output-btn:hover { background: rgba(0,212,255,0.3); }
    .output-btn.save-btn { background: rgba(0,255,136,0.2); border-color: var(--accent-green); color: var(--accent-green); }
    
    .score-output { background: var(--bg-input); border-radius: 10px; padding: 20px; font-family: 'Courier New', monospace; font-size: 11px; line-height: 1.4; white-space: pre; overflow-x: auto; min-height: 400px; color: var(--text-secondary); border: 1px solid rgba(255,255,255,0.05); }
    
    .output-tabs { display: flex; gap: 5px; margin-bottom: 15px; flex-wrap: wrap; }
    .tab-btn { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: var(--text-secondary); padding: 8px 16px; border-radius: 8px 8px 0 0; cursor: pointer; font-size: 0.85rem; transition: all 0.3s; }
    .tab-btn:hover { background: rgba(255,255,255,0.1); }
    .tab-btn.active { background: var(--bg-input); border-bottom-color: var(--bg-input); color: var(--accent-gold); }
    
    /* Save Modal */
    .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center; }
    .modal.show { display: flex; }
    .modal-content { background: var(--bg-card); border-radius: 15px; padding: 30px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .modal-header h2 { color: var(--accent-gold); }
    .modal-close { background: none; border: none; color: var(--text-secondary); font-size: 1.5rem; cursor: pointer; }
    
    /* Toast */
    .toast { position: fixed; bottom: 30px; right: 30px; background: var(--bg-card); border: 1px solid var(--accent-green); color: var(--accent-green); padding: 15px 25px; border-radius: 10px; z-index: 2000; transform: translateY(100px); opacity: 0; transition: all 0.3s; }
    .toast.show { transform: translateY(0); opacity: 1; }
    .toast.error { border-color: var(--accent-pink); color: var(--accent-pink); }
    
    /* Profile Modal */
    .profile-header { display: flex; align-items: center; gap: 20px; margin-bottom: 30px; padding: 20px; background: linear-gradient(135deg, rgba(157,78,221,0.2), rgba(0,212,255,0.1)); border-radius: 12px; }
    .profile-avatar { width: 80px; height: 80px; background: linear-gradient(135deg, var(--accent-purple), var(--accent-cyan)); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; font-weight: bold; }
    .profile-info h3 { font-size: 1.5rem; margin-bottom: 5px; }
    .profile-info p { color: var(--text-secondary); margin: 0; }
    .profile-meta { font-size: 0.85rem !important; opacity: 0.7; }
    .profile-stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 30px; }
    @media (max-width: 600px) { .profile-stats-grid { grid-template-columns: repeat(2, 1fr); } }
    .profile-stat-card { background: var(--bg-input); border-radius: 10px; padding: 15px; text-align: center; }
    .profile-stat-value { font-size: 1.5rem; font-weight: bold; color: var(--accent-cyan); }
    .profile-stat-label { color: var(--text-secondary); font-size: 0.8rem; margin-top: 5px; }
    .profile-section { margin-bottom: 25px; }
    .profile-section h4 { color: var(--accent-gold); margin-bottom: 15px; }
    .recent-scores-list { background: var(--bg-input); border-radius: 10px; overflow: hidden; }
    .recent-score-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; border-bottom: 1px solid rgba(255,255,255,0.05); }
    .recent-score-item:last-child { border-bottom: none; }
    .recent-score-item:hover { background: rgba(255,255,255,0.03); }
    .recent-score-title { font-weight: 500; }
    .recent-score-date { color: var(--text-secondary); font-size: 0.8rem; }
    .profile-actions { display: flex; gap: 15px; margin-top: 20px; }
    .profile-actions button { flex: 1; }
    .empty-recent { text-align: center; padding: 30px; color: var(--text-secondary); }
    
    /* Settings Modal */
    .modal-medium { max-width: 600px; }
    .settings-tabs { display: flex; gap: 5px; margin-bottom: 25px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; }
    .settings-tab { background: transparent; border: none; color: var(--text-secondary); padding: 10px 15px; cursor: pointer; border-radius: 8px; transition: all 0.3s; font-size: 0.9rem; }
    .settings-tab:hover { background: rgba(255,255,255,0.05); }
    .settings-tab.active { background: var(--accent-purple); color: #fff; }
    .settings-tab-content { display: none; }
    .settings-tab-content.active { display: block; }
    .settings-input-group { display: flex; gap: 10px; }
    .settings-text-input { flex: 1; background: var(--bg-input); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 10px 15px; color: var(--text-primary); font-size: 1rem; }
    .settings-text-input:focus { outline: none; border-color: var(--accent-cyan); }
    .settings-text-input.full { width: 100%; }
    .setting-select { background: var(--bg-input); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 8px 12px; color: var(--text-primary); font-size: 0.9rem; cursor: pointer; }
    .danger-zone { margin-top: 30px; padding: 20px; background: rgba(255,107,157,0.1); border: 1px solid rgba(255,107,157,0.3); border-radius: 10px; }
    .danger-zone h4 { color: var(--accent-pink); margin-bottom: 10px; }
    .danger-zone p { color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 15px; }
    .theme-options { display: flex; gap: 15px; flex-wrap: wrap; }
    .theme-option { display: flex; flex-direction: column; align-items: center; gap: 8px; padding: 15px; background: var(--bg-input); border: 2px solid rgba(255,255,255,0.1); border-radius: 12px; cursor: pointer; transition: all 0.3s; min-width: 100px; }
    .theme-option:hover { border-color: var(--accent-purple); }
    .theme-option.selected { border-color: var(--accent-green); background: rgba(0,255,136,0.1); }
    .theme-preview { width: 60px; height: 40px; border-radius: 6px; }
    .dark-preview { background: linear-gradient(135deg, #0a0a0f, #1a1a24); }
    .light-preview { background: linear-gradient(135deg, #f5f5f5, #ffffff); }
    .cosmic-preview { background: linear-gradient(135deg, #1a0a2e, #0a1628, #2a0a3e); }
    .theme-option span { font-size: 0.85rem; color: var(--text-secondary); }
    .theme-option.selected span { color: var(--accent-green); }
    
    /* Change Log Modal */
    .changelog-version-badge { display: flex; align-items: center; gap: 15px; margin-bottom: 25px; padding: 15px 20px; background: linear-gradient(135deg, rgba(157,78,221,0.2), rgba(0,212,255,0.1)); border-radius: 10px; }
    .version-number { font-size: 1.5rem; font-weight: bold; color: var(--accent-gold); }
    .version-date { color: var(--text-secondary); }
    .changelog-content { max-height: 400px; overflow-y: auto; padding-right: 10px; }
    .changelog-entry { margin-bottom: 25px; padding-bottom: 25px; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .changelog-entry:last-child { border-bottom: none; margin-bottom: 0; }
    .changelog-entry.roadmap { background: rgba(0,212,255,0.05); padding: 20px; border-radius: 10px; border: 1px dashed rgba(0,212,255,0.3); }
    .changelog-entry-header { display: flex; align-items: center; gap: 12px; margin-bottom: 15px; flex-wrap: wrap; }
    .changelog-entry-header h3 { font-size: 1.1rem; color: var(--accent-cyan); margin: 0; }
    .changelog-date { color: var(--text-secondary); font-size: 0.85rem; }
    .changelog-tag { padding: 3px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }
    .changelog-tag.new { background: rgba(0,255,136,0.2); color: var(--accent-green); }
    .changelog-tag.initial { background: rgba(157,78,221,0.2); color: var(--accent-purple); }
    .changelog-tag.upcoming { background: rgba(0,212,255,0.2); color: var(--accent-cyan); }
    .changelog-section { margin-bottom: 15px; }
    .changelog-section:last-child { margin-bottom: 0; }
    .changelog-section h4 { font-size: 0.95rem; color: var(--text-primary); margin-bottom: 10px; }
    .changelog-section ul { list-style: none; padding: 0; margin: 0; }
    .changelog-section li { padding: 6px 0 6px 20px; position: relative; color: var(--text-secondary); font-size: 0.9rem; }
    .changelog-section li::before { content: '‚Ä¢'; position: absolute; left: 0; color: var(--accent-purple); }
    .changelog-section li strong { color: var(--text-primary); }
    .changelog-footer { margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); text-align: center; }
    .changelog-footer p { color: var(--text-secondary); font-size: 0.85rem; margin: 0; }
    
    /* Scrollbar for changelog */
    .changelog-content::-webkit-scrollbar { width: 6px; }
    .changelog-content::-webkit-scrollbar-track { background: var(--bg-input); border-radius: 3px; }
    .changelog-content::-webkit-scrollbar-thumb { background: var(--accent-purple); border-radius: 3px; }
    .changelog-content::-webkit-scrollbar-thumb:hover { background: var(--accent-cyan); }
    
    /* Admin Panel */
    .modal-large { max-width: 800px; }
    .admin-tabs { display: flex; gap: 5px; margin-bottom: 20px; flex-wrap: wrap; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; }
    .admin-tab { background: transparent; border: none; color: var(--text-secondary); padding: 10px 20px; cursor: pointer; border-radius: 8px; transition: all 0.3s; }
    .admin-tab:hover { background: rgba(255,255,255,0.05); }
    .admin-tab.active { background: var(--accent-purple); color: #fff; }
    .admin-tab-content { display: none; }
    .admin-tab-content.active { display: block; }
    
    .admin-stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 30px; }
    .admin-stat-card { background: var(--bg-input); border-radius: 10px; padding: 20px; text-align: center; }
    .admin-stat-value { font-size: 2rem; font-weight: bold; color: var(--accent-cyan); }
    .admin-stat-label { color: var(--text-secondary); font-size: 0.85rem; }
    
    .users-table { background: var(--bg-input); border-radius: 10px; overflow: hidden; }
    .user-row { display: grid; grid-template-columns: 1fr 1fr auto auto; gap: 15px; padding: 15px 20px; border-bottom: 1px solid rgba(255,255,255,0.05); align-items: center; }
    .user-row:last-child { border-bottom: none; }
    .user-row.header { background: rgba(157,78,221,0.2); font-weight: 600; color: var(--accent-gold); }
    .user-name { font-weight: 500; }
    .user-meta { color: var(--text-secondary); font-size: 0.85rem; }
    .user-badge { background: var(--accent-purple); color: #fff; padding: 3px 10px; border-radius: 10px; font-size: 0.75rem; }
    .user-badge.admin { background: var(--accent-gold); color: #000; }
    
    .admin-actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 20px; }
    .btn-danger { background: rgba(255,107,157,0.2); border: 1px solid var(--accent-pink); color: var(--accent-pink); }
    .btn-danger:hover { background: rgba(255,107,157,0.3); }
    .btn-small { padding: 6px 12px; font-size: 0.8rem; border-radius: 6px; cursor: pointer; transition: all 0.3s; }
    
    .backup-section { margin-top: 30px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); }
    .backup-section h4 { color: var(--accent-gold); margin-bottom: 10px; }
    .backup-buttons { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px; }
    
    /* Settings */
    .settings-section { margin-bottom: 30px; }
    .settings-section h4 { color: var(--accent-gold); margin-bottom: 15px; }
    .setting-row { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: var(--bg-input); border-radius: 8px; margin-bottom: 10px; }
    .setting-info { flex: 1; }
    .setting-info label { display: block; font-weight: 500; margin-bottom: 3px; }
    .setting-info span { font-size: 0.8rem; color: var(--text-secondary); }
    .toggle { position: relative; width: 50px; height: 26px; }
    .toggle input { opacity: 0; width: 0; height: 0; }
    .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.2); border-radius: 26px; transition: 0.3s; }
    .toggle-slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background: white; border-radius: 50%; transition: 0.3s; }
    .toggle input:checked + .toggle-slider { background: var(--accent-green); }
    .toggle input:checked + .toggle-slider:before { transform: translateX(24px); }
    .setting-input { background: var(--bg-dark); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; padding: 8px 12px; color: var(--text-primary); width: 80px; text-align: center; }
    
    /* Footer */
    .footer { background: var(--bg-card); padding: 20px; text-align: center; border-top: 1px solid rgba(255,255,255,0.05); }
    .footer p { color: var(--text-secondary); font-size: 0.85rem; }
    .footer a { color: var(--accent-purple); text-decoration: none; }
    
    /* Login Banner */
    .login-banner { background: linear-gradient(135deg, rgba(157,78,221,0.3), rgba(0,212,255,0.2)); padding: 12px 20px; border-bottom: 1px solid rgba(157,78,221,0.3); }
    .login-banner-content { max-width: 1600px; margin: 0 auto; display: flex; align-items: center; justify-content: center; gap: 15px; flex-wrap: wrap; }
    .login-banner-icon { font-size: 1.2rem; }
    .login-banner-text { color: var(--text-primary); font-size: 0.95rem; }
    .login-banner-text a { color: var(--accent-cyan); text-decoration: none; font-weight: 600; }
    .login-banner-text a:hover { text-decoration: underline; }
    .login-banner-btn { background: linear-gradient(135deg, var(--accent-purple), var(--accent-pink)); border: none; color: #fff; padding: 8px 20px; border-radius: 20px; cursor: pointer; font-size: 0.85rem; font-weight: 600; transition: all 0.3s; }
    .login-banner-btn:hover { transform: scale(1.05); }
    
    /* Landing Composer */
    .landing-composer-container { padding: 20px; background: linear-gradient(180deg, rgba(157,78,221,0.1) 0%, transparent 100%); }
    .landing-composer-container .composer-container { min-height: auto; }
    .landing-composer-container .panel:first-child .panel-content { max-height: none; overflow-y: visible; }
    .landing-composer-container .panel:last-child .panel-content { max-height: 500px; overflow-y: auto; }
    .landing-composer-container .score-output { min-height: 300px; }
    
    /* CTA Section */
    .cta-section { padding: 60px 20px; text-align: center; background: linear-gradient(135deg, rgba(157,78,221,0.15), rgba(0,212,255,0.1)); margin-top: 40px; }
    .cta-section h2 { font-size: 1.8rem; color: var(--accent-gold); margin-bottom: 15px; }
    .cta-section p { color: var(--text-secondary); max-width: 600px; margin: 0 auto 25px; }
    
    /* Voice Selector Checkboxes */
    .voice-options { display: flex; gap: 8px; flex-wrap: wrap; }
    .voice-checkbox { display: flex; align-items: center; gap: 4px; background: var(--bg-input); border: 1px solid rgba(255,255,255,0.1); padding: 5px 10px; border-radius: 15px; cursor: pointer; font-size: 0.9rem; transition: all 0.3s; }
    .voice-checkbox:hover { border-color: var(--accent-cyan); }
    .voice-checkbox input { display: none; }
    .voice-checkbox input:checked + span { color: var(--accent-green); }
    .voice-checkbox:has(input:checked) { border-color: var(--accent-green); background: rgba(0,255,136,0.1); }
    .loop-btn { background: rgba(157,78,221,0.2); border: 1px solid var(--accent-purple); color: var(--accent-purple); }
    .loop-btn.active { background: rgba(255,215,0,0.2); border-color: var(--accent-gold); color: var(--accent-gold); }
    
    @media (max-width: 768px) {
      .nav { flex-direction: column; gap: 15px; }
      .options-grid { grid-template-columns: 1fr 1fr; }
      .select-row { grid-template-columns: 1fr; }
      .hero-buttons { flex-direction: column; }
      
      /* Mobile Score Output - Larger and more readable */
      .score-output { 
        font-size: 14px; 
        line-height: 1.6; 
        padding: 15px; 
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      .landing-composer-container .score-output { 
        min-height: 250px; 
        font-size: 14px;
      }
      
      /* Playback controls - larger touch targets */
      .output-btn { padding: 10px 16px; font-size: 1rem; }
      .voice-checkbox { padding: 8px 12px; font-size: 1rem; }
      .loop-btn { padding: 10px 16px; font-size: 1rem; }
      
      /* Panel adjustments */
      .panel-content { padding: 15px; }
      .panel-header { padding: 12px 15px; }
      .panel-header h2 { font-size: 1rem; }
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- ==================== LANDING SCREEN ==================== -->
    <div id="landing-screen" class="screen active">
      <nav class="nav">
        <a href="index.html" class="nav-logo">üåå COSMOS</a>
        <div class="nav-links">
          <a href="index.html">Home</a>
          <a href="notation.html">Notation</a>
          <a href="sheet-music.html">Sheet Music</a>
          <a href="composer.html" class="active">Composer</a>
          <button class="nav-btn nav-btn-secondary" onclick="showScreen('auth')">Log In</button>
        </div>
      </nav>
      
      <section class="hero" style="padding: 30px 20px;">
        <h1>üéº Music Composer Tool</h1>
        <p>Transform your words into sheet music instantly. Try it below - no account needed!</p>
      </section>
      
      <!-- Login Banner -->
      <div class="login-banner">
        <div class="login-banner-content">
          <span class="login-banner-icon">‚ú®</span>
          <span class="login-banner-text"><strong>Try the composer below!</strong> <a href="#" onclick="showScreen('auth'); return false;">Log in</a> or <a href="#" onclick="showScreen('auth'); return false;">Sign up</a> to save your scores.</span>
          <button class="login-banner-btn" onclick="showScreen('auth')">Get Started Free</button>
        </div>
      </div>
      
      <!-- Embedded Composer -->
      <div class="landing-composer-container">
        <div class="composer-container">
          <!-- Input Panel -->
          <div class="panel">
            <div class="panel-header">
              <h2>‚úèÔ∏è Your Words & Options</h2>
            </div>
            <div class="panel-content">
              <textarea class="lyrics-input" id="landingLyricsInput" placeholder="Enter your lyrics or words here...

Example:
do you see
what do you see
when you close your eyes
i see the light
an infinite number of stars"></textarea>
              
              <!-- Notation Format -->
              <div class="options-section">
                <h3>üìã Notation Format</h3>
                <div class="options-grid" id="landingNotationOptions">
                  <label class="option-item option-radio selected" data-value="piano-roll">
                    <span class="icon">üéπ</span>
                    <span class="label">Piano Roll</span>
                    <span class="check"></span>
                  </label>
                  <label class="option-item option-radio" data-value="treble-bass">
                    <span class="icon">üéº</span>
                    <span class="label">Treble/Bass</span>
                    <span class="check"></span>
                  </label>
                  <label class="option-item option-radio" data-value="ssaattbb">
                    <span class="icon">üé≠</span>
                    <span class="label">SSAATTBB</span>
                    <span class="check"></span>
                  </label>
                  <label class="option-item option-radio" data-value="lead-sheet">
                    <span class="icon">üìÑ</span>
                    <span class="label">Lead Sheet</span>
                    <span class="check"></span>
                  </label>
                </div>
              </div>
              
              <!-- Musical Style -->
              <div class="options-section">
                <h3>üé® Musical Style</h3>
                <div class="options-grid" id="landingStyleOptions">
                  <label class="option-item option-radio selected" data-value="operatic">
                    <span class="icon">üé≠</span>
                    <span class="label">Operatic</span>
                    <span class="check"></span>
                  </label>
                  <label class="option-item option-radio" data-value="hypnotic">
                    <span class="icon">üåÄ</span>
                    <span class="label">Hypnotic</span>
                    <span class="check"></span>
                  </label>
                  <label class="option-item option-radio" data-value="trance">
                    <span class="icon">‚ú®</span>
                    <span class="label">Trance</span>
                    <span class="check"></span>
                  </label>
                  <label class="option-item option-radio" data-value="classical">
                    <span class="icon">üèõÔ∏è</span>
                    <span class="label">Classical</span>
                    <span class="check"></span>
                  </label>
                </div>
              </div>
              
              <!-- Parameters -->
              <div class="options-section">
                <h3>‚öôÔ∏è Parameters</h3>
                <div class="select-row">
                  <div class="select-group">
                    <label>Key</label>
                    <select id="landingKeySelect">
                      <option value="C">C Major</option>
                      <option value="G">G Major</option>
                      <option value="D">D Major</option>
                      <option value="Am">A Minor</option>
                    </select>
                  </div>
                  <div class="select-group">
                    <label>Voice</label>
                    <select id="landingVoiceSelect">
                      <option value="soprano">Soprano</option>
                      <option value="mezzo" selected>Mezzo</option>
                      <option value="tenor">Tenor</option>
                      <option value="baritone">Baritone</option>
                    </select>
                  </div>
                </div>
              </div>
              
              <button class="generate-btn" onclick="generateLandingScore()">
                <span>üéµ</span> Generate Sheet Music
              </button>
            </div>
          </div>
          
          <!-- Output Panel -->
          <div class="panel">
            <div class="panel-header">
              <h2>üìú Generated Score</h2>
              <div class="output-actions">
                <button class="output-btn play-btn" id="landingPlayBtn" onclick="playLandingScore()">‚ñ∂Ô∏è Play</button>
                <button class="output-btn" id="landingPauseBtn" onclick="pauseLandingScore()" style="display:none;">‚è∏Ô∏è Pause</button>
                <button class="output-btn" id="landingStopBtn" onclick="stopLandingScore()">‚èπÔ∏è Stop</button>
                <button class="output-btn" onclick="copyLandingScore()">üìã Copy</button>
                <button class="output-btn" onclick="downloadLandingScore()">üíæ Download</button>
                <button class="output-btn save-btn" onclick="promptLoginToSave()">‚ú® Save</button>
              </div>
            </div>
            <!-- Playback Progress -->
            <div id="landingPlaybackProgress" style="display:none; padding: 10px 20px; background: rgba(157,78,221,0.2); border-bottom: 1px solid rgba(255,255,255,0.1);">
              <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                <span id="landingCurrentNote" style="color: var(--accent-cyan); font-weight: 600; min-width: 50px;">Ready</span>
                <div style="flex: 1; min-width: 100px; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden;">
                  <div id="landingProgressBar" style="width: 0%; height: 100%; background: linear-gradient(90deg, var(--accent-purple), var(--accent-pink)); transition: width 0.1s;"></div>
                </div>
                <div class="voice-options" id="landingVoiceOptions">
                  <label class="voice-checkbox" title="Pure tone"><input type="checkbox" value="pure" checked onchange="changeLandingVoice()"><span>üéµ</span></label>
                  <label class="voice-checkbox" title="Choir pad"><input type="checkbox" value="choir" onchange="changeLandingVoice()"><span>üéôÔ∏è</span></label>
                  <label class="voice-checkbox" title="Organ"><input type="checkbox" value="organ" onchange="changeLandingVoice()"><span>üéπ</span></label>
                  <label class="voice-checkbox" title="Strings"><input type="checkbox" value="strings" onchange="changeLandingVoice()"><span>üéª</span></label>
                  <label class="voice-checkbox" title="Rich harmonics"><input type="checkbox" value="rich" onchange="changeLandingVoice()"><span>‚ú®</span></label>
                </div>
                <button class="output-btn loop-btn" id="landingLoopBtn" onclick="toggleLandingLoop()">‚Üª Loop</button>
                <span id="landingPlaybackTime" style="color: var(--text-secondary); font-size: 0.85rem;">0:00</span>
              </div>
            </div>
            <div class="panel-content">
              <div class="score-output" id="landingScoreOutput">Enter lyrics above and click Generate to create sheet music...

‚ú® Try it now - no account needed!

üíæ Want to save your scores? Log in or sign up for free.</div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Features Section -->
      <section style="max-width: 1000px; margin: 60px auto; padding: 0 20px;">
        <h2 style="text-align: center; color: var(--accent-gold); margin-bottom: 40px;">How It Works</h2>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 30px;">
          <div style="text-align: center; padding: 30px; background: var(--bg-card); border-radius: 15px;">
            <div style="font-size: 3rem; margin-bottom: 15px;">‚úèÔ∏è</div>
            <h3 style="color: var(--accent-cyan); margin-bottom: 10px;">1. Enter Words</h3>
            <p style="color: var(--text-secondary);">Type or paste your lyrics, poetry, or any text.</p>
          </div>
          <div style="text-align: center; padding: 30px; background: var(--bg-card); border-radius: 15px;">
            <div style="font-size: 3rem; margin-bottom: 15px;">üé®</div>
            <h3 style="color: var(--accent-cyan); margin-bottom: 10px;">2. Choose Style</h3>
            <p style="color: var(--text-secondary);">Select notation format, musical style, and dynamics.</p>
          </div>
          <div style="text-align: center; padding: 30px; background: var(--bg-card); border-radius: 15px;">
            <div style="font-size: 3rem; margin-bottom: 15px;">üéº</div>
            <h3 style="color: var(--accent-cyan); margin-bottom: 10px;">3. Generate</h3>
            <p style="color: var(--text-secondary);">AI creates sheet music with pitches, dynamics, and VRN codes.</p>
          </div>
          <div style="text-align: center; padding: 30px; background: var(--bg-card); border-radius: 15px;">
            <div style="font-size: 3rem; margin-bottom: 15px;">üíæ</div>
            <h3 style="color: var(--accent-cyan); margin-bottom: 10px;">4. Save & Share</h3>
            <p style="color: var(--text-secondary);">Save to your library, download, or copy to clipboard.</p>
          </div>
        </div>
      </section>
      
      <!-- CTA Section -->
      <section class="cta-section">
        <h2>Ready to Save Your Compositions?</h2>
        <p>Create a free account to save your scores, access them anywhere, and build your musical library.</p>
        <div class="hero-buttons">
          <button class="btn-large btn-primary" onclick="showScreen('auth')">‚ú® Create Free Account</button>
          <button class="btn-large btn-secondary" onclick="showChangelogModal()">üìã What's New</button>
        </div>
      </section>
      
      <footer class="footer">
        <p>¬© 2002-2026 COSMOS the OPERA. All Rights Reserved.<br>
        <a href="index.html">Home</a> | <a href="composition.html">AI Composition Guide</a> | <a href="notation.html">VRN Guide</a> | <a href="#" onclick="showChangelogModal(); return false;">Change Log</a></p>
      </footer>
    </div>
    
    <!-- ==================== AUTH SCREEN ==================== -->
    <div id="auth-screen" class="screen">
      <nav class="nav">
        <a href="index.html" class="nav-logo">üåå COSMOS</a>
        <div class="nav-links">
          <a href="#" onclick="showScreen('landing'); return false;">‚Üê Back</a>
        </div>
      </nav>
      
      <div class="auth-container">
        <div class="auth-header">
          <h2>üéº Music Composer</h2>
          <p style="color: var(--text-secondary);">Create and save your sheet music</p>
        </div>
        
        <div class="auth-tabs">
          <button class="auth-tab active" data-tab="login" onclick="switchAuthTab('login')">Log In</button>
          <button class="auth-tab" data-tab="signup" onclick="switchAuthTab('signup')">Sign Up</button>
        </div>
        
        <!-- Login Form -->
        <form id="login-form" class="auth-form active" onsubmit="handleLogin(event)">
          <div class="form-group">
            <label>Username</label>
            <input type="text" id="login-username" placeholder="Enter username" required>
          </div>
          <div class="form-group">
            <label>Password</label>
            <input type="password" id="login-password" placeholder="Enter password" required>
          </div>
          <div class="form-error" id="login-error"></div>
          <button type="submit" class="btn-large btn-primary full-width">Log In</button>
        </form>
        
        <!-- Signup Form -->
        <form id="signup-form" class="auth-form" onsubmit="handleSignup(event)">
          <div class="form-group">
            <label>Display Name</label>
            <input type="text" id="signup-name" placeholder="Your name" required>
          </div>
          <div class="form-group">
            <label>Username</label>
            <input type="text" id="signup-username" placeholder="Choose a username" required>
          </div>
          <div class="form-group">
            <label>Password</label>
            <input type="password" id="signup-password" placeholder="Min 6 characters" required minlength="6">
          </div>
          <div class="form-error" id="signup-error"></div>
          <button type="submit" class="btn-large btn-primary full-width">Create Account</button>
        </form>
        
        <div class="auth-footer">
          <button class="btn-large btn-secondary full-width" style="margin-bottom: 15px;" onclick="startDemo()">üëÅÔ∏è Try Demo Instead</button>
          <p>Your data is stored locally in your browser.</p>
        </div>
      </div>
    </div>
    
    <!-- ==================== DASHBOARD SCREEN ==================== -->
    <div id="dashboard-screen" class="screen">
      <nav class="nav">
        <a href="index.html" class="nav-logo">üåå COSMOS</a>
        <div class="nav-links">
          <a href="index.html">Home</a>
          <a href="notation.html">Notation</a>
          <a href="sheet-music.html">Sheet Music</a>
          <a href="composer.html" class="active">Composer</a>
          <div class="user-menu" onclick="toggleUserMenu(event)">
            <span id="user-display-name">User</span>
            <div class="user-avatar" id="user-avatar">U</div>
            <div class="user-dropdown" id="user-dropdown">
              <a href="#" onclick="showScreen('composer'); return false;">‚ú® New Score</a>
              <a href="#" onclick="showProfileModal(); return false;">üë§ My Profile</a>
              <a href="#" onclick="showSettingsModal(); return false;">‚öôÔ∏è Settings</a>
              <a href="#" onclick="showChangelogModal(); return false;">üìã Change Log</a>
              <a href="#" id="admin-link" style="display:none;" onclick="showAdminPanel(); return false;">üõ°Ô∏è Admin</a>
              <a href="#" onclick="handleLogout(); return false;">üö™ Log Out</a>
            </div>
          </div>
        </div>
      </nav>
      
      <div class="dashboard-header">
        <div style="max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px;">
          <div>
            <h1>My Scores</h1>
            <p>Your saved sheet music compositions</p>
          </div>
          <button class="btn-large btn-primary" onclick="showScreen('composer')">‚ú® New Score</button>
        </div>
      </div>
      
      <div class="dashboard-content">
        <div class="scores-grid" id="scores-grid">
          <!-- Populated by JS -->
        </div>
        
        <div class="empty-state" id="empty-scores" style="display: none;">
          <div class="icon">üéº</div>
          <h3>No saved scores yet</h3>
          <p>Create your first sheet music composition</p>
          <button class="btn-large btn-primary" onclick="showScreen('composer')">‚ú® Create Your First Score</button>
        </div>
      </div>
    </div>
    
    <!-- ==================== COMPOSER SCREEN ==================== -->
    <div id="composer-screen" class="screen">
      <nav class="nav">
        <a href="index.html" class="nav-logo">üåå COSMOS</a>
        <div class="nav-links">
          <a href="#" onclick="goBackFromComposer(); return false;">‚Üê Back</a>
          <a href="index.html">Home</a>
          <a href="notation.html">Notation</a>
          <a href="sheet-music.html">Sheet Music</a>
          <a href="composer.html" class="active">Composer</a>
          <div class="user-menu" onclick="toggleUserMenu(event)">
            <span id="composer-user-display-name">User</span>
            <div class="user-avatar" id="composer-user-avatar">U</div>
            <div class="user-dropdown" id="composer-user-dropdown">
              <a href="#" onclick="showScreen('composer'); return false;">‚ú® New Score</a>
              <a href="#" onclick="showProfileModal(); return false;">üë§ My Profile</a>
              <a href="#" onclick="showSettingsModal(); return false;">‚öôÔ∏è Settings</a>
              <a href="#" onclick="showChangelogModal(); return false;">üìã Change Log</a>
              <a href="#" id="composer-admin-link" style="display:none;" onclick="showAdminPanel(); return false;">üõ°Ô∏è Admin</a>
              <a href="#" onclick="handleLogout(); return false;">üö™ Log Out</a>
            </div>
          </div>
        </div>
      </nav>
      
      <div class="composer-container">
        <!-- Input Panel -->
        <div class="panel">
          <div class="panel-header">
            <h2>‚úèÔ∏è Your Words & Options</h2>
          </div>
          <div class="panel-content">
            <textarea class="lyrics-input" id="lyricsInput" placeholder="Enter your lyrics or words here...

Example:
do you see
what do you see
when you close your eyes
i see the light
an infinite number of stars"></textarea>
            
            <!-- Notation Format -->
            <div class="options-section">
              <h3>üìã Notation Format</h3>
              <div class="options-grid" id="notationOptions">
                <label class="option-item option-radio selected" data-value="piano-roll">
                  <span class="icon">üéπ</span>
                  <span class="label">Piano Roll</span>
                  <span class="check"></span>
                </label>
                <label class="option-item option-radio" data-value="treble-bass">
                  <span class="icon">üéº</span>
                  <span class="label">Treble/Bass</span>
                  <span class="check"></span>
                </label>
                <label class="option-item option-radio" data-value="ssaattbb">
                  <span class="icon">üé≠</span>
                  <span class="label">SSAATTBB</span>
                  <span class="check"></span>
                </label>
                <label class="option-item option-radio" data-value="lead-sheet">
                  <span class="icon">üìÑ</span>
                  <span class="label">Lead Sheet</span>
                  <span class="check"></span>
                </label>
              </div>
            </div>
            
            <!-- Dynamics -->
            <div class="options-section">
              <h3>üîä Dynamics & Expression</h3>
              <div class="options-grid" id="dynamicsOptions">
                <label class="option-item selected" data-value="traditional">
                  <span class="icon">üéµ</span>
                  <span class="label">Traditional</span>
                  <span class="check"></span>
                </label>
                <label class="option-item selected" data-value="vrn">
                  <span class="icon">üó£Ô∏è</span>
                  <span class="label">VRN Codes</span>
                  <span class="check"></span>
                </label>
                <label class="option-item" data-value="expressive">
                  <span class="icon">üí´</span>
                  <span class="label">Expressive</span>
                  <span class="check"></span>
                </label>
              </div>
            </div>
            
            <!-- Musical Style -->
            <div class="options-section">
              <h3>üé® Musical Style</h3>
              <div class="options-grid" id="styleOptions">
                <label class="option-item option-radio selected" data-value="operatic">
                  <span class="icon">üé≠</span>
                  <span class="label">Operatic</span>
                  <span class="check"></span>
                </label>
                <label class="option-item option-radio" data-value="hypnotic">
                  <span class="icon">üåÄ</span>
                  <span class="label">Hypnotic</span>
                  <span class="check"></span>
                </label>
                <label class="option-item option-radio" data-value="trance">
                  <span class="icon">‚ú®</span>
                  <span class="label">Trance</span>
                  <span class="check"></span>
                </label>
                <label class="option-item option-radio" data-value="classical">
                  <span class="icon">üèõÔ∏è</span>
                  <span class="label">Classical</span>
                  <span class="check"></span>
                </label>
                <label class="option-item option-radio" data-value="jazz">
                  <span class="icon">üé∑</span>
                  <span class="label">Jazz</span>
                  <span class="check"></span>
                </label>
                <label class="option-item option-radio" data-value="folk">
                  <span class="icon">ü™ï</span>
                  <span class="label">Folk</span>
                  <span class="check"></span>
                </label>
              </div>
            </div>
            
            <!-- Parameters -->
            <div class="options-section">
              <h3>‚öôÔ∏è Parameters</h3>
              <div class="select-row">
                <div class="select-group">
                  <label>Key</label>
                  <select id="keySelect">
                    <option value="C">C Major</option>
                    <option value="G">G Major</option>
                    <option value="D">D Major</option>
                    <option value="F">F Major</option>
                    <option value="Am">A Minor</option>
                    <option value="Em">E Minor</option>
                  </select>
                </div>
                <div class="select-group">
                  <label>Tempo</label>
                  <select id="tempoSelect">
                    <option value="60">Largo (60)</option>
                    <option value="72" selected>Andante (72)</option>
                    <option value="90">Moderato (90)</option>
                    <option value="120">Allegro (120)</option>
                  </select>
                </div>
              </div>
              <div class="select-row">
                <div class="select-group">
                  <label>Time</label>
                  <select id="timeSelect">
                    <option value="4/4">4/4</option>
                    <option value="3/4">3/4</option>
                    <option value="6/8">6/8</option>
                  </select>
                </div>
                <div class="select-group">
                  <label>Voice</label>
                  <select id="voiceSelect">
                    <option value="soprano">Soprano</option>
                    <option value="mezzo" selected>Mezzo</option>
                    <option value="tenor">Tenor</option>
                    <option value="baritone">Baritone</option>
                  </select>
                </div>
              </div>
            </div>
            
            <button class="generate-btn" onclick="generateScore()">
              <span>üéµ</span> Generate Sheet Music
            </button>
          </div>
        </div>
        
        <!-- Output Panel -->
        <div class="panel">
          <div class="panel-header">
            <h2>üìú Generated Score</h2>
            <div class="output-actions">
              <button class="output-btn play-btn" id="playBtn" onclick="playScore()">‚ñ∂Ô∏è Play</button>
              <button class="output-btn" id="pauseBtn" onclick="pauseScore()" style="display:none;">‚è∏Ô∏è Pause</button>
              <button class="output-btn" id="stopBtn" onclick="stopScore()">‚èπÔ∏è Stop</button>
              <button class="output-btn" onclick="copyScore()">üìã Copy</button>
              <button class="output-btn" onclick="downloadScore()">üíæ Download</button>
              <button class="output-btn save-btn" id="saveScoreBtn" onclick="showSaveModal()">‚ú® Save</button>
            </div>
          </div>
          <!-- Playback Progress -->
          <div id="playbackProgress" style="display:none; padding: 10px 20px; background: rgba(157,78,221,0.2); border-bottom: 1px solid rgba(255,255,255,0.1);">
            <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
              <span id="currentNote" style="color: var(--accent-cyan); font-weight: 600; min-width: 50px;">Ready</span>
              <div style="flex: 1; min-width: 100px; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden;">
                <div id="progressBar" style="width: 0%; height: 100%; background: linear-gradient(90deg, var(--accent-purple), var(--accent-pink)); transition: width 0.1s;"></div>
              </div>
              <div class="voice-options" id="voiceOptions">
                <label class="voice-checkbox" title="Pure tone"><input type="checkbox" value="pure" checked onchange="changeVoice()"><span>üéµ</span></label>
                <label class="voice-checkbox" title="Choir pad"><input type="checkbox" value="choir" onchange="changeVoice()"><span>üéôÔ∏è</span></label>
                <label class="voice-checkbox" title="Organ"><input type="checkbox" value="organ" onchange="changeVoice()"><span>üéπ</span></label>
                <label class="voice-checkbox" title="Strings"><input type="checkbox" value="strings" onchange="changeVoice()"><span>üéª</span></label>
                <label class="voice-checkbox" title="Rich harmonics"><input type="checkbox" value="rich" onchange="changeVoice()"><span>‚ú®</span></label>
              </div>
              <button class="output-btn loop-btn" id="loopBtn" onclick="toggleLoop()">‚Üª Loop</button>
              <span id="playbackTime" style="color: var(--text-secondary); font-size: 0.85rem;">0:00</span>
            </div>
          </div>
          <div class="panel-content">
            <div class="output-tabs">
              <button class="tab-btn active" onclick="switchTab('score')">Score</button>
              <button class="tab-btn" onclick="switchTab('vrn')">VRN Guide</button>
            </div>
            <div class="score-output" id="scoreOutput">Enter lyrics and click Generate to create sheet music...</div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- ==================== SAVE MODAL ==================== -->
    <div id="save-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>üíæ Save Score</h2>
          <button class="modal-close" onclick="closeSaveModal()">√ó</button>
        </div>
        <form onsubmit="saveScore(event)">
          <div class="form-group">
            <label>Score Title</label>
            <input type="text" id="score-title" placeholder="My Composition" required>
          </div>
          <div class="form-group">
            <label>Description (optional)</label>
            <input type="text" id="score-description" placeholder="Notes about this score">
          </div>
          <button type="submit" class="btn-large btn-primary full-width">Save to My Scores</button>
        </form>
      </div>
    </div>
    
    <!-- Toast -->
    <div class="toast" id="toast"></div>
    
    <!-- ==================== USER PROFILE MODAL ==================== -->
    <div id="profile-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>üë§ My Profile</h2>
          <button class="modal-close" onclick="closeProfileModal()">√ó</button>
        </div>
        
        <div class="profile-header">
          <div class="profile-avatar" id="profile-avatar">U</div>
          <div class="profile-info">
            <h3 id="profile-display-name">User</h3>
            <p id="profile-username">@username</p>
            <p id="profile-member-since" class="profile-meta">Member since...</p>
          </div>
        </div>
        
        <div class="profile-stats-grid">
          <div class="profile-stat-card">
            <div class="profile-stat-value" id="profile-total-scores">0</div>
            <div class="profile-stat-label">Total Scores</div>
          </div>
          <div class="profile-stat-card">
            <div class="profile-stat-value" id="profile-this-month">0</div>
            <div class="profile-stat-label">This Month</div>
          </div>
          <div class="profile-stat-card">
            <div class="profile-stat-value" id="profile-fav-style">-</div>
            <div class="profile-stat-label">Favorite Style</div>
          </div>
          <div class="profile-stat-card">
            <div class="profile-stat-value" id="profile-fav-notation">-</div>
            <div class="profile-stat-label">Favorite Notation</div>
          </div>
        </div>
        
        <div class="profile-section">
          <h4>üìä Recent Activity</h4>
          <div class="recent-scores-list" id="recent-scores-list">
            <!-- Populated by JS -->
          </div>
        </div>
        
        <div class="profile-actions">
          <button class="btn-large btn-secondary" onclick="closeProfileModal(); showSettingsModal();">‚öôÔ∏è Edit Settings</button>
          <button class="btn-large btn-primary" onclick="closeProfileModal(); showScreen('composer');">‚ú® New Score</button>
        </div>
      </div>
    </div>
    
    <!-- ==================== USER SETTINGS MODAL ==================== -->
    <div id="settings-modal" class="modal">
      <div class="modal-content modal-medium">
        <div class="modal-header">
          <h2>‚öôÔ∏è Settings</h2>
          <button class="modal-close" onclick="closeSettingsModal()">√ó</button>
        </div>
        
        <div class="settings-tabs">
          <button class="settings-tab active" data-tab="account" onclick="switchSettingsTab('account')">üë§ Account</button>
          <button class="settings-tab" data-tab="preferences" onclick="switchSettingsTab('preferences')">üé® Preferences</button>
          <button class="settings-tab" data-tab="defaults" onclick="switchSettingsTab('defaults')">üéµ Defaults</button>
        </div>
        
        <!-- Account Tab -->
        <div id="settings-account-tab" class="settings-tab-content active">
          <div class="settings-section">
            <h4>Display Name</h4>
            <div class="settings-input-group">
              <input type="text" id="settings-display-name" class="settings-text-input" placeholder="Your display name">
              <button class="btn-small btn-primary" onclick="updateDisplayName()">Update</button>
            </div>
          </div>
          
          <div class="settings-section">
            <h4>Change Password</h4>
            <div class="form-group">
              <label>Current Password</label>
              <input type="password" id="settings-current-password" class="settings-text-input full">
            </div>
            <div class="form-group">
              <label>New Password</label>
              <input type="password" id="settings-new-password" class="settings-text-input full" minlength="6">
            </div>
            <div class="form-group">
              <label>Confirm New Password</label>
              <input type="password" id="settings-confirm-password" class="settings-text-input full">
            </div>
            <button class="btn-large btn-primary" onclick="updatePassword()">Change Password</button>
          </div>
          
          <div class="settings-section danger-zone">
            <h4>‚ö†Ô∏è Danger Zone</h4>
            <p>Permanently delete your account and all your scores. This cannot be undone.</p>
            <button class="btn-large btn-danger" onclick="deleteOwnAccount()">Delete My Account</button>
          </div>
        </div>
        
        <!-- Preferences Tab -->
        <div id="settings-preferences-tab" class="settings-tab-content">
          <div class="settings-section">
            <h4>üé® Theme</h4>
            <div class="theme-options" id="theme-options">
              <label class="theme-option selected" data-theme="dark">
                <div class="theme-preview dark-preview"></div>
                <span>Dark</span>
              </label>
              <label class="theme-option" data-theme="light">
                <div class="theme-preview light-preview"></div>
                <span>Light</span>
              </label>
              <label class="theme-option" data-theme="cosmic">
                <div class="theme-preview cosmic-preview"></div>
                <span>Cosmic</span>
              </label>
            </div>
          </div>
          
          <div class="settings-section">
            <h4>üîî Notifications</h4>
            <div class="setting-row">
              <div class="setting-info">
                <label>Show Toast Notifications</label>
                <span>Display confirmation messages</span>
              </div>
              <label class="toggle">
                <input type="checkbox" id="pref-show-toasts" checked onchange="saveUserPreferences()">
                <span class="toggle-slider"></span>
              </label>
            </div>
            <div class="setting-row">
              <div class="setting-info">
                <label>Auto-save Drafts</label>
                <span>Save work-in-progress automatically</span>
              </div>
              <label class="toggle">
                <input type="checkbox" id="pref-auto-save" onchange="saveUserPreferences()">
                <span class="toggle-slider"></span>
              </label>
            </div>
          </div>
          
          <div class="settings-section">
            <h4>üìã Display</h4>
            <div class="setting-row">
              <div class="setting-info">
                <label>Compact Score Cards</label>
                <span>Show smaller cards in dashboard</span>
              </div>
              <label class="toggle">
                <input type="checkbox" id="pref-compact-cards" onchange="saveUserPreferences()">
                <span class="toggle-slider"></span>
              </label>
            </div>
            <div class="setting-row">
              <div class="setting-info">
                <label>Score Font Size</label>
                <span>Size of generated score text</span>
              </div>
              <select id="pref-font-size" class="setting-select" onchange="saveUserPreferences()">
                <option value="9">Small (9px)</option>
                <option value="11" selected>Medium (11px)</option>
                <option value="13">Large (13px)</option>
                <option value="15">Extra Large (15px)</option>
              </select>
            </div>
          </div>
        </div>
        
        <!-- Defaults Tab -->
        <div id="settings-defaults-tab" class="settings-tab-content">
          <div class="settings-section">
            <h4>üéµ Default Composition Settings</h4>
            <p style="color: var(--text-secondary); margin-bottom: 20px;">These will be pre-selected when you create a new score.</p>
            
            <div class="select-row">
              <div class="select-group">
                <label>Default Notation</label>
                <select id="default-notation" onchange="saveUserPreferences()">
                  <option value="piano-roll">Piano Roll</option>
                  <option value="treble-bass">Treble/Bass</option>
                  <option value="ssaattbb">SSAATTBB</option>
                  <option value="lead-sheet">Lead Sheet</option>
                </select>
              </div>
              <div class="select-group">
                <label>Default Style</label>
                <select id="default-style" onchange="saveUserPreferences()">
                  <option value="operatic">Operatic</option>
                  <option value="hypnotic">Hypnotic</option>
                  <option value="trance">Trance</option>
                  <option value="classical">Classical</option>
                  <option value="jazz">Jazz</option>
                  <option value="folk">Folk</option>
                </select>
              </div>
            </div>
            
            <div class="select-row">
              <div class="select-group">
                <label>Default Key</label>
                <select id="default-key" onchange="saveUserPreferences()">
                  <option value="C">C Major</option>
                  <option value="G">G Major</option>
                  <option value="D">D Major</option>
                  <option value="F">F Major</option>
                  <option value="Am">A Minor</option>
                  <option value="Em">E Minor</option>
                </select>
              </div>
              <div class="select-group">
                <label>Default Tempo</label>
                <select id="default-tempo" onchange="saveUserPreferences()">
                  <option value="60">Largo (60)</option>
                  <option value="72">Andante (72)</option>
                  <option value="90">Moderato (90)</option>
                  <option value="120">Allegro (120)</option>
                </select>
              </div>
            </div>
            
            <div class="select-row">
              <div class="select-group">
                <label>Default Time Signature</label>
                <select id="default-time" onchange="saveUserPreferences()">
                  <option value="4/4">4/4</option>
                  <option value="3/4">3/4</option>
                  <option value="6/8">6/8</option>
                </select>
              </div>
              <div class="select-group">
                <label>Default Voice</label>
                <select id="default-voice" onchange="saveUserPreferences()">
                  <option value="soprano">Soprano</option>
                  <option value="mezzo">Mezzo</option>
                  <option value="tenor">Tenor</option>
                  <option value="baritone">Baritone</option>
                </select>
              </div>
            </div>
            
            <div class="settings-section" style="margin-top: 20px;">
              <h4>Default Dynamics</h4>
              <div class="options-grid" id="default-dynamics-options">
                <label class="option-item selected" data-value="traditional">
                  <span class="icon">üéµ</span>
                  <span class="label">Traditional</span>
                  <span class="check"></span>
                </label>
                <label class="option-item selected" data-value="vrn">
                  <span class="icon">üó£Ô∏è</span>
                  <span class="label">VRN Codes</span>
                  <span class="check"></span>
                </label>
                <label class="option-item" data-value="expressive">
                  <span class="icon">üí´</span>
                  <span class="label">Expressive</span>
                  <span class="check"></span>
                </label>
              </div>
            </div>
          </div>
          
          <button class="btn-large btn-secondary" onclick="resetDefaults()">Reset to Factory Defaults</button>
        </div>
      </div>
    </div>
    
    <!-- ==================== CHANGE LOG MODAL ==================== -->
    <div id="changelog-modal" class="modal">
      <div class="modal-content modal-medium">
        <div class="modal-header">
          <h2>üìã Change Log</h2>
          <button class="modal-close" onclick="closeChangelogModal()">√ó</button>
        </div>
        
        <div class="changelog-version-badge">
          <span class="version-number">v1.3.0</span>
          <span class="version-date">January 2026</span>
        </div>
        
        <div class="changelog-content">
          <!-- Version 1.3.0 -->
          <div class="changelog-entry">
            <div class="changelog-entry-header">
              <h3>v1.3.0</h3>
              <span class="changelog-date">January 21, 2026</span>
              <span class="changelog-tag new">Latest</span>
            </div>
            <div class="changelog-section">
              <h4>‚ú® New Features</h4>
              <ul>
                <li><strong>Audio Playback</strong> - Play generated scores with Web Audio synthesis</li>
                <li><strong>Playback Controls</strong> - Play, Pause, Stop buttons with progress bar</li>
                <li><strong>Dynamic Volume</strong> - Volume adjusts based on dynamics (pp to fff)</li>
                <li><strong>Rich Vocal Tone</strong> - Harmonics for realistic vocal-like sound</li>
                <li><strong>Live Note Display</strong> - See current note, word, and VRN code during playback</li>
              </ul>
            </div>
          </div>
          
          <!-- Version 1.2.0 -->
          <div class="changelog-entry">
            <div class="changelog-entry-header">
              <h3>v1.2.0</h3>
              <span class="changelog-date">January 21, 2026</span>
            </div>
            <div class="changelog-section">
              <h4>‚ú® New Features</h4>
              <ul>
                <li><strong>User Profile</strong> - View your stats, favorite styles, and recent activity</li>
                <li><strong>User Settings</strong> - Customize your experience with themes, preferences, and defaults</li>
                <li><strong>Theme Options</strong> - Choose between Dark, Light, and Cosmic themes</li>
                <li><strong>Default Composition Settings</strong> - Set your preferred notation, style, key, and more</li>
                <li><strong>Change Log</strong> - Track updates and new features</li>
              </ul>
            </div>
            <div class="changelog-section">
              <h4>üêõ Bug Fixes</h4>
              <ul>
                <li>Improved modal close behavior on outside click</li>
                <li>Fixed user preferences not persisting across sessions</li>
              </ul>
            </div>
          </div>
          
          <!-- Version 1.1.0 -->
          <div class="changelog-entry">
            <div class="changelog-entry-header">
              <h3>v1.1.0</h3>
              <span class="changelog-date">January 15, 2026</span>
            </div>
            <div class="changelog-section">
              <h4>‚ú® New Features</h4>
              <ul>
                <li><strong>Admin Panel</strong> - Manage users, view statistics, backup/restore data</li>
                <li><strong>User Management</strong> - Create accounts, promote admins, delete users</li>
                <li><strong>Data Backup</strong> - Export and import all application data</li>
                <li><strong>App Settings</strong> - Configure registration, limits, and maintenance mode</li>
              </ul>
            </div>
            <div class="changelog-section">
              <h4>üõ†Ô∏è Improvements</h4>
              <ul>
                <li>Enhanced score card previews in dashboard</li>
                <li>Better error handling for authentication</li>
              </ul>
            </div>
          </div>
          
          <!-- Version 1.0.0 -->
          <div class="changelog-entry">
            <div class="changelog-entry-header">
              <h3>v1.0.0</h3>
              <span class="changelog-date">January 1, 2026</span>
              <span class="changelog-tag initial">Initial Release</span>
            </div>
            <div class="changelog-section">
              <h4>üéâ Initial Release</h4>
              <ul>
                <li><strong>Music Composer Tool</strong> - Transform words into sheet music</li>
                <li><strong>Multiple Notation Formats</strong> - Piano Roll, Treble/Bass, SSAATTBB, Lead Sheet</li>
                <li><strong>Musical Styles</strong> - Operatic, Hypnotic, Trance, Classical, Jazz, Folk</li>
                <li><strong>VRN Integration</strong> - Vocal Resonance Notation codes</li>
                <li><strong>User Accounts</strong> - Sign up, log in, save scores</li>
                <li><strong>Score Management</strong> - Save, open, delete, copy, download scores</li>
                <li><strong>Demo Mode</strong> - Try without creating an account</li>
              </ul>
            </div>
          </div>
          
          <!-- Roadmap -->
          <div class="changelog-entry roadmap">
            <div class="changelog-entry-header">
              <h3>üìç Roadmap</h3>
              <span class="changelog-tag upcoming">Coming Soon</span>
            </div>
            <div class="changelog-section">
              <h4>üöÄ Planned Features</h4>
              <ul>
                <li>MIDI export functionality</li>
                <li>PDF score generation</li>
                <li>Collaboration features</li>
                <li>Custom VRN code editor</li>
                <li>Score sharing and public gallery</li>
                <li>Multi-voice playback</li>
              </ul>
            </div>
          </div>
        </div>
        
        <div class="changelog-footer">
          <p>Have feedback or feature requests? Let us know!</p>
        </div>
      </div>
    </div>
    
    <!-- ==================== ADMIN MODAL ==================== -->
    <div id="admin-modal" class="modal">
      <div class="modal-content modal-large">
        <div class="modal-header">
          <h2>üõ°Ô∏è Admin Panel</h2>
          <button class="modal-close" onclick="closeAdminPanel()">√ó</button>
        </div>
        
        <div class="admin-tabs">
          <button class="admin-tab active" data-tab="stats" onclick="switchAdminTab('stats')">üìä Statistics</button>
          <button class="admin-tab" data-tab="settings" onclick="switchAdminTab('settings')">‚öôÔ∏è Settings</button>
          <button class="admin-tab" data-tab="users" onclick="switchAdminTab('users')">üë• Users</button>
          <button class="admin-tab" data-tab="data" onclick="switchAdminTab('data')">üíæ Data</button>
        </div>
        
        <!-- Stats Tab -->
        <div id="admin-stats-tab" class="admin-tab-content active">
          <div class="admin-stats-grid">
            <div class="admin-stat-card">
              <div class="admin-stat-value" id="stat-total-users">0</div>
              <div class="admin-stat-label">Total Users</div>
            </div>
            <div class="admin-stat-card">
              <div class="admin-stat-value" id="stat-total-scores">0</div>
              <div class="admin-stat-label">Total Scores</div>
            </div>
            <div class="admin-stat-card">
              <div class="admin-stat-value" id="stat-admin-users">0</div>
              <div class="admin-stat-label">Admin Users</div>
            </div>
          </div>
          <p style="color: var(--text-secondary); font-size: 0.85rem;">App Version: 1.0.0 | Data stored locally in browser</p>
        </div>
        
        <!-- Settings Tab -->
        <div id="admin-settings-tab" class="admin-tab-content">
          <div class="settings-section">
            <h4>üîê Registration</h4>
            <div class="setting-row">
              <div class="setting-info">
                <label>Allow Public Signup</label>
                <span>Anyone can create an account</span>
              </div>
              <label class="toggle">
                <input type="checkbox" id="setting-public-signup" checked onchange="saveSettings()">
                <span class="toggle-slider"></span>
              </label>
            </div>
          </div>
          
          <div class="settings-section">
            <h4>üìä Limits</h4>
            <div class="setting-row">
              <div class="setting-info">
                <label>Max Scores per User</label>
                <span>Maximum number of saved scores per user</span>
              </div>
              <input type="number" class="setting-input" id="setting-max-scores" value="50" min="1" max="500" onchange="saveSettings()">
            </div>
          </div>
          
          <div class="settings-section">
            <h4>üé® Features</h4>
            <div class="setting-row">
              <div class="setting-info">
                <label>Demo Mode Available</label>
                <span>Allow users to try without signing up</span>
              </div>
              <label class="toggle">
                <input type="checkbox" id="setting-demo-mode" checked onchange="saveSettings()">
                <span class="toggle-slider"></span>
              </label>
            </div>
            <div class="setting-row">
              <div class="setting-info">
                <label>Maintenance Mode</label>
                <span>Only admins can access the app</span>
              </div>
              <label class="toggle">
                <input type="checkbox" id="setting-maintenance" onchange="saveSettings()">
                <span class="toggle-slider"></span>
              </label>
            </div>
          </div>
          
          <button class="btn-large btn-primary" onclick="saveSettings(); showToast('Settings saved!');">Save Settings</button>
        </div>
        
        <!-- Users Tab -->
        <div id="admin-users-tab" class="admin-tab-content">
          <div class="users-table" id="users-table">
            <div class="user-row header">
              <div>Username</div>
              <div>Display Name</div>
              <div>Role</div>
              <div>Actions</div>
            </div>
            <!-- Users populated by JS -->
          </div>
        </div>
        
        <!-- Data Tab -->
        <div id="admin-data-tab" class="admin-tab-content">
          <div class="backup-section">
            <h4>üíæ Backup & Restore</h4>
            <p style="color: var(--text-secondary); margin-bottom: 15px;">Download all data or restore from a backup file.</p>
            <div class="backup-buttons">
              <button class="btn-large btn-secondary" onclick="exportAllData()">üì• Download Backup</button>
              <label class="btn-large btn-secondary" style="cursor: pointer;">
                üì§ Restore Backup
                <input type="file" id="restore-file" accept=".json" onchange="restoreData(event)" hidden>
              </label>
            </div>
          </div>
          
          <div class="backup-section">
            <h4>üóëÔ∏è Danger Zone</h4>
            <p style="color: var(--text-secondary); margin-bottom: 15px;">Permanently delete all data. This cannot be undone!</p>
            <button class="btn-large btn-danger" onclick="resetAllData()">Reset All Data</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
// ==================== STORAGE ====================
const Storage = {
  KEYS: {
    USERS: 'cosmos_composer_users',
    CURRENT_USER: 'cosmos_composer_current_user',
    SCORES: 'cosmos_composer_scores',
    SETTINGS: 'cosmos_composer_settings'
  },
  
  DEFAULT_ADMIN: { username: 'admin', password: 'admin123', displayName: 'Administrator', isAdmin: true },
  DEFAULT_DEMO: { username: 'demo', password: 'demo123', displayName: 'Demo User', isAdmin: false },
  
  init() {
    if (!localStorage.getItem(this.KEYS.USERS)) {
      const users = {};
      users['admin'] = { id: 'admin_001', ...this.DEFAULT_ADMIN, createdAt: new Date().toISOString() };
      users['demo'] = { id: 'demo_001', ...this.DEFAULT_DEMO, createdAt: new Date().toISOString() };
      localStorage.setItem(this.KEYS.USERS, JSON.stringify(users));
    }
    if (!localStorage.getItem(this.KEYS.SCORES)) {
      localStorage.setItem(this.KEYS.SCORES, JSON.stringify({}));
    }
    if (!localStorage.getItem(this.KEYS.SETTINGS)) {
      localStorage.setItem(this.KEYS.SETTINGS, JSON.stringify({
        allowPublicSignup: true,
        maxScoresPerUser: 50,
        demoModeEnabled: true,
        maintenanceMode: false
      }));
    }
    // Add sample scores for demo user
    this.initDemoContent();
  },
  
  initDemoContent() {
    const scores = this.getAllScores();
    const demoScores = Object.values(scores).filter(s => s.userId === 'demo_001');
    if (demoScores.length > 0) return;
    
    scores['demo_score_001'] = {
      id: 'demo_score_001',
      userId: 'demo_001',
      title: 'Do You See',
      description: 'Opening scene from COSMOS',
      notation: 'piano-roll',
      style: 'operatic',
      key: 'C',
      lyrics: 'do you see\nwhat do you see\nwhen you close your eyes',
      output: '‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n‚îÇ  PIANO ROLL SCORE\n‚îÇ  Key: C  Time: 4/4  Tempo: ‚ô©=72  Voice: mezzo  Style: operatic\n‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n‚îÇ\n‚îÇ  Sample score preview...',
      createdAt: new Date(Date.now() - 7*24*60*60*1000).toISOString()
    };
    localStorage.setItem(this.KEYS.SCORES, JSON.stringify(scores));
  },
  
  getUsers() { return JSON.parse(localStorage.getItem(this.KEYS.USERS) || '{}'); },
  getUserByUsername(username) { return this.getUsers()[username.toLowerCase()] || null; },
  getCurrentUser() {
    const username = localStorage.getItem(this.KEYS.CURRENT_USER);
    return username ? this.getUserByUsername(username) : null;
  },
  setCurrentUser(username) { localStorage.setItem(this.KEYS.CURRENT_USER, username.toLowerCase()); },
  clearCurrentUser() { localStorage.removeItem(this.KEYS.CURRENT_USER); },
  
  createUser(data) {
    const users = this.getUsers();
    const username = data.username.toLowerCase();
    if (users[username]) throw new Error('Username already exists');
    users[username] = {
      id: Date.now().toString(36) + Math.random().toString(36).substr(2),
      username,
      displayName: data.displayName,
      password: data.password,
      isAdmin: false,
      createdAt: new Date().toISOString()
    };
    localStorage.setItem(this.KEYS.USERS, JSON.stringify(users));
    return users[username];
  },
  
  getAllScores() { return JSON.parse(localStorage.getItem(this.KEYS.SCORES) || '{}'); },
  getUserScores(userId) {
    return Object.values(this.getAllScores()).filter(s => s.userId === userId).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
  },
  
  saveScore(scoreData) {
    const scores = this.getAllScores();
    const id = Date.now().toString(36) + Math.random().toString(36).substr(2);
    scores[id] = { id, ...scoreData, createdAt: new Date().toISOString() };
    localStorage.setItem(this.KEYS.SCORES, JSON.stringify(scores));
    return scores[id];
  },
  
  deleteScore(id) {
    const scores = this.getAllScores();
    delete scores[id];
    localStorage.setItem(this.KEYS.SCORES, JSON.stringify(scores));
  },
  
  getSettings() {
    return JSON.parse(localStorage.getItem(this.KEYS.SETTINGS) || '{}');
  },
  
  saveSettings(settings) {
    localStorage.setItem(this.KEYS.SETTINGS, JSON.stringify(settings));
  }
};

Storage.init();

// ==================== AUTH ====================
let isDemo = false;

function handleLogin(e) {
  e.preventDefault();
  const username = document.getElementById('login-username').value;
  const password = document.getElementById('login-password').value;
  const errorEl = document.getElementById('login-error');
  
  try {
    const user = Storage.getUserByUsername(username);
    if (!user) throw new Error('User not found');
    if (user.password !== password) throw new Error('Incorrect password');
    Storage.setCurrentUser(username);
    isDemo = false;
    showScreen('dashboard');
    updateUserUI();
  } catch (err) {
    errorEl.textContent = err.message;
  }
}

function handleSignup(e) {
  e.preventDefault();
  const displayName = document.getElementById('signup-name').value;
  const username = document.getElementById('signup-username').value;
  const password = document.getElementById('signup-password').value;
  const errorEl = document.getElementById('signup-error');
  
  try {
    if (!/^[a-zA-Z0-9_]+$/.test(username)) throw new Error('Username: letters, numbers, underscores only');
    Storage.createUser({ displayName, username, password });
    Storage.setCurrentUser(username);
    isDemo = false;
    showScreen('dashboard');
    updateUserUI();
    showToast('Account created!');
  } catch (err) {
    errorEl.textContent = err.message;
  }
}

function handleLogout() {
  Storage.clearCurrentUser();
  isDemo = false;
  showScreen('landing');
}

function startDemo() {
  Storage.setCurrentUser('demo');
  isDemo = true;
  showScreen('dashboard');
  updateUserUI();
  showToast('Demo mode - your changes are saved locally');
}

function updateUserUI() {
  const user = Storage.getCurrentUser();
  if (user) {
    // Update dashboard user menu
    document.getElementById('user-display-name').textContent = user.displayName;
    document.getElementById('user-avatar').textContent = user.displayName.charAt(0).toUpperCase();
    document.getElementById('admin-link').style.display = user.isAdmin ? 'block' : 'none';
    
    // Update composer screen user menu
    const composerDisplayName = document.getElementById('composer-user-display-name');
    const composerAvatar = document.getElementById('composer-user-avatar');
    const composerAdminLink = document.getElementById('composer-admin-link');
    
    if (composerDisplayName) composerDisplayName.textContent = user.displayName;
    if (composerAvatar) composerAvatar.textContent = user.displayName.charAt(0).toUpperCase();
    if (composerAdminLink) composerAdminLink.style.display = user.isAdmin ? 'block' : 'none';
    
    loadUserScores();
  }
}

// ==================== SCREENS ====================
function showScreen(screenId) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(screenId + '-screen').classList.add('active');
  
  if (screenId === 'dashboard') {
    loadUserScores();
  }
  
  if (screenId === 'composer') {
    // Apply user's default composition settings
    applyDefaultsToComposer();
  }
}

function goBackFromComposer() {
  const user = Storage.getCurrentUser();
  if (user) {
    showScreen('dashboard');
  } else {
    showScreen('landing');
  }
}

function switchAuthTab(tab) {
  document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
  document.querySelector(`.auth-tab[data-tab="${tab}"]`).classList.add('active');
  document.getElementById(tab + '-form').classList.add('active');
}

function toggleUserMenu(event) {
  // Close all dropdowns first
  document.querySelectorAll('.user-dropdown').forEach(dropdown => {
    if (!event || !event.currentTarget.contains(dropdown)) {
      dropdown.classList.remove('show');
    }
  });
  
  // Toggle the dropdown inside the clicked user-menu
  if (event && event.currentTarget) {
    const dropdown = event.currentTarget.querySelector('.user-dropdown');
    if (dropdown) dropdown.classList.toggle('show');
  } else {
    // Fallback for old-style calls
    document.getElementById('user-dropdown')?.classList.toggle('show');
  }
}

document.addEventListener('click', (e) => {
  if (!e.target.closest('.user-menu')) {
    document.getElementById('user-dropdown')?.classList.remove('show');
    document.getElementById('composer-user-dropdown')?.classList.remove('show');
  }
});

// ==================== SCORES DASHBOARD ====================
function loadUserScores() {
  const user = Storage.getCurrentUser();
  if (!user) return;
  
  const scores = Storage.getUserScores(user.id);
  const grid = document.getElementById('scores-grid');
  const empty = document.getElementById('empty-scores');
  
  if (scores.length === 0) {
    grid.innerHTML = '';
    empty.style.display = 'block';
    return;
  }
  
  empty.style.display = 'none';
  grid.innerHTML = scores.map(score => `
    <div class="score-card">
      <div class="score-card-header">
        <div class="score-card-title">${escapeHtml(score.title)}</div>
        <div class="score-card-meta">
          <span>${score.notation}</span>
          <span>${score.style}</span>
          <span>${score.key}</span>
        </div>
      </div>
      <div class="score-card-body">
        <div class="score-card-preview">${escapeHtml(score.output?.substring(0, 200) || '')}</div>
      </div>
      <div class="score-card-actions">
        <button class="score-card-btn primary" onclick="openScore('${score.id}')">Open</button>
        <button class="score-card-btn secondary" onclick="deleteScoreConfirm('${score.id}')">Delete</button>
      </div>
    </div>
  `).join('');
}

function openScore(id) {
  const scores = Storage.getAllScores();
  const score = scores[id];
  if (!score) return;
  
  document.getElementById('lyricsInput').value = score.lyrics || '';
  
  // Set notation
  document.querySelectorAll('#notationOptions .option-item').forEach(opt => {
    opt.classList.toggle('selected', opt.dataset.value === score.notation);
  });
  
  // Set style
  document.querySelectorAll('#styleOptions .option-item').forEach(opt => {
    opt.classList.toggle('selected', opt.dataset.value === score.style);
  });
  
  document.getElementById('keySelect').value = score.key || 'C';
  document.getElementById('scoreOutput').textContent = score.output || '';
  
  showScreen('composer');
}

function deleteScoreConfirm(id) {
  if (confirm('Delete this score? This cannot be undone.')) {
    Storage.deleteScore(id);
    loadUserScores();
    showToast('Score deleted');
  }
}

// ==================== SAVE MODAL ====================
let currentGeneratedOutput = '';

function showSaveModal() {
  const user = Storage.getCurrentUser();
  if (!user) {
    showToast('Please log in to save scores', true);
    return;
  }
  if (!currentGeneratedOutput) {
    showToast('Generate a score first', true);
    return;
  }
  document.getElementById('save-modal').classList.add('show');
}

function closeSaveModal() {
  document.getElementById('save-modal').classList.remove('show');
}

function saveScore(e) {
  e.preventDefault();
  const user = Storage.getCurrentUser();
  if (!user) return;
  
  const title = document.getElementById('score-title').value;
  const description = document.getElementById('score-description').value;
  const lyrics = document.getElementById('lyricsInput').value;
  const notation = getSelectedRadio('notationOptions');
  const style = getSelectedRadio('styleOptions');
  const key = document.getElementById('keySelect').value;
  
  Storage.saveScore({
    userId: user.id,
    title,
    description,
    lyrics,
    notation,
    style,
    key,
    output: currentGeneratedOutput
  });
  
  closeSaveModal();
  showToast('Score saved!');
  document.getElementById('score-title').value = '';
  document.getElementById('score-description').value = '';
}

// ==================== TOAST ====================
function showToast(message, isError = false) {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.className = 'toast show' + (isError ? ' error' : '');
  setTimeout(() => toast.classList.remove('show'), 3000);
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// ==================== OPTION HANDLING ====================
document.querySelectorAll('.option-item').forEach(item => {
  item.addEventListener('click', function() {
    const parent = this.parentElement;
    const isRadio = this.classList.contains('option-radio');
    if (isRadio) {
      parent.querySelectorAll('.option-item').forEach(i => i.classList.remove('selected'));
    }
    this.classList.toggle('selected', isRadio || !this.classList.contains('selected'));
  });
});

function getSelectedOptions(containerId) {
  return [...document.getElementById(containerId).querySelectorAll('.option-item.selected')].map(i => i.dataset.value);
}

function getSelectedRadio(containerId) {
  const sel = document.getElementById(containerId).querySelector('.option-item.selected');
  return sel ? sel.dataset.value : null;
}

// ==================== COMPOSER ENGINE ====================
const voiceRanges = {
  soprano: { scale: ['C4','D4','E4','F4','G4','A4','B4','C5','D5','E5','F5','G5','A5','B5','C6'] },
  mezzo: { scale: ['A3','B3','C4','D4','E4','F4','G4','A4','B4','C5','D5','E5','F5','G5','A5'] },
  tenor: { scale: ['C3','D3','E3','F3','G3','A3','B3','C4','D4','E4','F4','G4','A4','B4','C5'] },
  baritone: { scale: ['A2','B2','C3','D3','E3','F3','G3','A3','B3','C4','D4','E4','F4','G4','A4'] }
};

const stylePatterns = {
  operatic: { intervals: [2,3,4,5,7], dynamics: ['p','mp','mf','f','ff','fff'] },
  hypnotic: { intervals: [1,2,3], dynamics: ['p','mp','mf'] },
  trance: { intervals: [2,3,5], dynamics: ['p','mf','f','ff'] },
  classical: { intervals: [2,3,4,5], dynamics: ['p','mp','mf','f'] },
  jazz: { intervals: [1,2,3,4,6,7], dynamics: ['mp','mf','f'] },
  folk: { intervals: [2,3,5], dynamics: ['mp','mf'] }
};

function getVRNCode(pitch, emotion, intensity) {
  const noteNum = parseInt(pitch.slice(-1));
  let code = noteNum <= 3 ? 'C' : (noteNum === 4 ? 'M' : 'H');
  return `[${code}${'+'.repeat(Math.min(3, intensity))}]`;
}

function parseLyrics(text) {
  const lines = text.trim().split('\n').filter(l => l.trim());
  const words = [];
  lines.forEach((line, lineIdx) => {
    line.trim().split(/\s+/).forEach((word, wordIdx, arr) => {
      if (word) words.push({ text: word.toLowerCase(), isLineStart: wordIdx === 0, isLineEnd: wordIdx === arr.length - 1, lineNum: lineIdx });
    });
  });
  return words;
}

function generateMelody(words, voice, style) {
  const range = voiceRanges[voice];
  const pattern = stylePatterns[style];
  const melody = [];
  let currentIdx = Math.floor(range.scale.length / 2);
  
  words.forEach((word, i) => {
    const progress = i / words.length;
    const emotion = progress > 0.7 ? 'powerful' : (progress < 0.3 ? 'tender' : 'building');
    const intensity = Math.ceil(progress * 3);
    let interval = pattern.intervals[Math.floor(Math.random() * pattern.intervals.length)];
    let direction = Math.random() > 0.5 ? 1 : -1;
    if (progress > 0.5) direction = 1;
    if (word.isLineStart && i > 0) currentIdx = Math.max(currentIdx - 2, 2);
    currentIdx = Math.max(0, Math.min(range.scale.length - 1, currentIdx + (direction * interval)));
    if (progress > 0.8 && progress < 0.9) currentIdx = Math.min(currentIdx + 3, range.scale.length - 2);
    
    melody.push({
      word: word.text, pitch: range.scale[currentIdx], vrn: getVRNCode(range.scale[currentIdx], emotion, intensity),
      dynamic: pattern.dynamics[Math.min(Math.floor(progress * pattern.dynamics.length), pattern.dynamics.length - 1)],
      isLineStart: word.isLineStart, isLineEnd: word.isLineEnd, lineNum: word.lineNum, emotion
    });
  });
  return melody;
}

function generatePianoRollNotation(melody) {
  const key = document.getElementById('keySelect').value;
  const time = document.getElementById('timeSelect').value;
  const tempo = document.getElementById('tempoSelect').value;
  const voice = document.getElementById('voiceSelect').value;
  const style = getSelectedRadio('styleOptions');
  const dynamics = getSelectedOptions('dynamicsOptions');
  
  const lines = [];
  let currentLineNotes = [], currentLineNum = -1;
  melody.forEach(note => {
    if (note.lineNum !== currentLineNum) {
      if (currentLineNotes.length > 0) lines.push(currentLineNotes);
      currentLineNotes = [];
      currentLineNum = note.lineNum;
    }
    currentLineNotes.push(note);
  });
  if (currentLineNotes.length > 0) lines.push(currentLineNotes);
  
  let output = `‚îå${'‚îÄ'.repeat(78)}\n‚îÇ  PIANO ROLL SCORE\n‚îÇ  Key: ${key}  Time: ${time}  Tempo: ‚ô©=${tempo}  Voice: ${voice}  Style: ${style}\n‚îú${'‚îÄ'.repeat(78)}\n`;
  
  let measureNum = 1;
  const noteNames = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
  
  lines.forEach(lineNotes => {
    const pitchNums = lineNotes.map(n => {
      const note = n.pitch.slice(0,-1), octave = parseInt(n.pitch.slice(-1));
      return octave * 12 + noteNames.indexOf(note);
    });
    const minP = Math.min(...pitchNums), maxP = Math.max(...pitchNums);
    const pitchLabels = [];
    for (let p = maxP + 1; p >= minP - 1; p--) {
      pitchLabels.push({ name: noteNames[p % 12] + Math.floor(p / 12), num: p });
    }
    
    const lyricsPreview = lineNotes.map(n => n.word).join(' ');
    output += `‚îÇ\n‚îÇ  MEASURES ${measureNum}-${measureNum + 15}: "${lyricsPreview.substring(0,40)}"  ${lineNotes[lineNotes.length-1].dynamic}\n‚îÇ\n‚îÇ  ${voice.toUpperCase()}:\n`;
    
    pitchLabels.forEach(pi => {
      let line = `‚îÇ  ${pi.name.padEnd(4)} `;
      lineNotes.forEach(note => {
        const np = parseInt(note.pitch.slice(-1)) * 12 + noteNames.indexOf(note.pitch.slice(0,-1));
        line += np === pi.num ? (note.isLineEnd ? `${'‚îÄ'.repeat(6)}‚óè~~~~~~~` : `${'‚îÄ'.repeat(6)}‚ô™${'‚îÄ'.repeat(7)}`) : `${'‚îÄ'.repeat(14)}`;
      });
      output += line + '\n';
    });
    
    if (dynamics.includes('vrn')) {
      output += `‚îÇ\n‚îÇ       `;
      lineNotes.forEach(n => output += n.vrn.padEnd(14));
      output += '\n';
    }
    output += `‚îÇ       `;
    lineNotes.forEach(n => output += `"${n.word}" `.padEnd(14));
    output += `\n‚îÇ\n‚îú${'‚îÄ'.repeat(78)}\n`;
    measureNum += 16;
  });
  
  return output + `‚îî${'‚îÄ'.repeat(78)}\n`;
}

function generateScore() {
  const lyrics = document.getElementById('lyricsInput').value.trim();
  if (!lyrics) { showToast('Enter lyrics first', true); return; }
  
  const voice = document.getElementById('voiceSelect').value;
  const style = getSelectedRadio('styleOptions');
  const notation = getSelectedRadio('notationOptions');
  const words = parseLyrics(lyrics);
  if (words.length === 0) { showToast('No valid words found', true); return; }
  
  // Generate and store melody for playback
  currentMelody = generateMelody(words, voice, style);
  let output = generatePianoRollNotation(currentMelody);
  
  document.getElementById('scoreOutput').textContent = output;
  currentGeneratedOutput = output;
  
  // Reset playback state
  stopScore();
  document.getElementById('playbackProgress').style.display = 'block';
  document.getElementById('currentNote').textContent = `Ready - ${currentMelody.length} notes`;
  
  showToast('Score generated! Click Play to hear it.');
}

function switchTab(tab) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.textContent.toLowerCase().includes(tab)));
  const output = document.getElementById('scoreOutput');
  if (tab === 'vrn') {
    output.textContent = `
VRN (Vocal Resonance Notation) Quick Guide:

PRIMARY CODES:
[C]  = Chest Voice    - Full chest resonance
[H]  = Head Voice     - Upper resonance, light
[M]  = Mix Voice      - Balanced chest/head

INTENSITY:
+    = Slight
++   = Moderate  
+++  = Maximum

MIXED:
[CM] = Chest-Mix
[HM] = Head-Mix

EXTENDED:
[N]  = Nasal (forward, bright)
[O]  = Oral (open throat)
[Oc] = Occipital (back resonance)
[SP] = Soft Palate (raised)`;
  }
}

function copyScore() {
  navigator.clipboard.writeText(document.getElementById('scoreOutput').textContent);
  showToast('Copied!');
}

function downloadScore() {
  const blob = new Blob([document.getElementById('scoreOutput').textContent], { type: 'text/plain' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'cosmos-score.txt';
  a.click();
}

// ==================== AUDIO PLAYBACK ====================
let audioContext = null;
let currentMelody = [];
let isPlaying = false;
let isPaused = false;
let playbackIndex = 0;
let playbackTimeout = null;
let startTime = 0;
let pausedAt = 0;

// Note frequencies (A4 = 440Hz)
const noteFrequencies = {
  'C2': 65.41, 'C#2': 69.30, 'D2': 73.42, 'D#2': 77.78, 'E2': 82.41, 'F2': 87.31, 'F#2': 92.50, 'G2': 98.00, 'G#2': 103.83, 'A2': 110.00, 'A#2': 116.54, 'B2': 123.47,
  'C3': 130.81, 'C#3': 138.59, 'D3': 146.83, 'D#3': 155.56, 'E3': 164.81, 'F3': 174.61, 'F#3': 185.00, 'G3': 196.00, 'G#3': 207.65, 'A3': 220.00, 'A#3': 233.08, 'B3': 246.94,
  'C4': 261.63, 'C#4': 277.18, 'D4': 293.66, 'D#4': 311.13, 'E4': 329.63, 'F4': 349.23, 'F#4': 369.99, 'G4': 392.00, 'G#4': 415.30, 'A4': 440.00, 'A#4': 466.16, 'B4': 493.88,
  'C5': 523.25, 'C#5': 554.37, 'D5': 587.33, 'D#5': 622.25, 'E5': 659.25, 'F5': 698.46, 'F#5': 739.99, 'G5': 783.99, 'G#5': 830.61, 'A5': 880.00, 'A#5': 932.33, 'B5': 987.77,
  'C6': 1046.50, 'C#6': 1108.73, 'D6': 1174.66, 'D#6': 1244.51, 'E6': 1318.51, 'F6': 1396.91, 'F#6': 1479.98, 'G6': 1567.98, 'G#6': 1661.22, 'A6': 1760.00, 'A#6': 1864.66, 'B6': 1975.53
};

function initAudio() {
  if (!audioContext) {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
  }
  if (audioContext.state === 'suspended') {
    audioContext.resume();
  }
}

function playNote(frequency, duration, startTime, volume = 0.3) {
  // Use voice presets
  playNoteWithVoices(audioContext, frequency, duration, startTime, volume, selectedVoices);
}

function playScore() {
  if (currentMelody.length === 0) {
    showToast('Generate a score first', true);
    return;
  }

  initAudio();
  
  if (isPaused) {
    isPaused = false;
    isPlaying = true;
    updatePlaybackUI();
    playFromIndex(playbackIndex);
    return;
  }

  stopScore();
  isPlaying = true;
  playbackIndex = 0;
  startTime = Date.now();
  
  document.getElementById('playbackProgress').style.display = 'block';
  updatePlaybackUI();
  playFromIndex(0);
}

function playFromIndex(index) {
  if (!isPlaying || index >= currentMelody.length) {
    if (index >= currentMelody.length) {
      if (loopEnabled) {
        // Loop back to beginning
        playbackIndex = 0;
        startTime = Date.now();
        showToast('Looping...');
        playFromIndex(0);
        return;
      }
      stopScore();
      showToast('Playback complete');
    }
    return;
  }

  const note = currentMelody[index];
  const tempo = parseInt(document.getElementById('tempoSelect').value) || 72;
  const beatDuration = 60 / tempo;
  const noteDuration = beatDuration * 0.8;
  
  const freq = noteFrequencies[note.pitch];
  if (freq) {
    const dynamicVolumes = { 'ppp': 0.1, 'pp': 0.15, 'p': 0.2, 'mp': 0.25, 'mf': 0.3, 'f': 0.4, 'ff': 0.5, 'fff': 0.6 };
    const volume = dynamicVolumes[note.dynamic] || 0.3;
    playNote(freq, noteDuration, audioContext.currentTime, volume);
  }

  playbackIndex = index;
  updateProgressUI(index, currentMelody.length, note);

  const nextDelay = beatDuration * 1000;
  playbackTimeout = setTimeout(() => {
    playFromIndex(index + 1);
  }, nextDelay);
}

function pauseScore() {
  if (isPlaying && !isPaused) {
    isPaused = true;
    isPlaying = false;
    pausedAt = playbackIndex;
    if (playbackTimeout) {
      clearTimeout(playbackTimeout);
      playbackTimeout = null;
    }
    updatePlaybackUI();
    showToast('Paused');
  }
}

function stopScore() {
  isPlaying = false;
  isPaused = false;
  playbackIndex = 0;
  pausedAt = 0;
  
  if (playbackTimeout) {
    clearTimeout(playbackTimeout);
    playbackTimeout = null;
  }
  
  document.getElementById('progressBar').style.width = '0%';
  document.getElementById('currentNote').textContent = 'Ready';
  document.getElementById('playbackTime').textContent = '0:00';
  updatePlaybackUI();
}

function updatePlaybackUI() {
  const playBtn = document.getElementById('playBtn');
  const pauseBtn = document.getElementById('pauseBtn');
  const stopBtn = document.getElementById('stopBtn');
  
  if (isPlaying) {
    playBtn.style.display = 'none';
    pauseBtn.style.display = 'inline-block';
    stopBtn.style.background = 'rgba(255,107,157,0.3)';
  } else if (isPaused) {
    playBtn.innerHTML = '‚ñ∂Ô∏è Resume';
    playBtn.style.display = 'inline-block';
    pauseBtn.style.display = 'none';
    stopBtn.style.background = '';
  } else {
    playBtn.innerHTML = '‚ñ∂Ô∏è Play';
    playBtn.style.display = 'inline-block';
    pauseBtn.style.display = 'none';
    stopBtn.style.background = '';
  }
}

function updateProgressUI(current, total, note) {
  const progress = ((current + 1) / total) * 100;
  document.getElementById('progressBar').style.width = progress + '%';
  document.getElementById('currentNote').textContent = `‚ô™ ${note.pitch} - "${note.word}" ${note.vrn}`;
  
  const elapsed = Math.floor((Date.now() - startTime) / 1000);
  const mins = Math.floor(elapsed / 60);
  const secs = elapsed % 60;
  document.getElementById('playbackTime').textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
}

// ==================== USER PROFILE ====================
function showProfileModal() {
  const user = Storage.getCurrentUser();
  if (!user) {
    showToast('Please log in first', true);
    return;
  }
  
  // Populate profile header
  document.getElementById('profile-avatar').textContent = user.displayName.charAt(0).toUpperCase();
  document.getElementById('profile-display-name').textContent = user.displayName;
  document.getElementById('profile-username').textContent = '@' + user.username;
  
  const createdDate = user.createdAt ? new Date(user.createdAt).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) : 'Unknown';
  document.getElementById('profile-member-since').textContent = 'Member since ' + createdDate;
  
  // Calculate stats
  const scores = Storage.getUserScores(user.id);
  const now = new Date();
  const thisMonth = scores.filter(s => {
    const created = new Date(s.createdAt);
    return created.getMonth() === now.getMonth() && created.getFullYear() === now.getFullYear();
  });
  
  // Find favorite style and notation
  const styleCounts = {};
  const notationCounts = {};
  scores.forEach(s => {
    if (s.style) styleCounts[s.style] = (styleCounts[s.style] || 0) + 1;
    if (s.notation) notationCounts[s.notation] = (notationCounts[s.notation] || 0) + 1;
  });
  
  const favStyle = Object.entries(styleCounts).sort((a, b) => b[1] - a[1])[0];
  const favNotation = Object.entries(notationCounts).sort((a, b) => b[1] - a[1])[0];
  
  document.getElementById('profile-total-scores').textContent = scores.length;
  document.getElementById('profile-this-month').textContent = thisMonth.length;
  document.getElementById('profile-fav-style').textContent = favStyle ? capitalize(favStyle[0]) : '-';
  document.getElementById('profile-fav-notation').textContent = favNotation ? formatNotation(favNotation[0]) : '-';
  
  // Recent scores
  const recentList = document.getElementById('recent-scores-list');
  const recentScores = scores.slice(0, 5);
  
  if (recentScores.length === 0) {
    recentList.innerHTML = '<div class="empty-recent">No scores yet. Start creating!</div>';
  } else {
    recentList.innerHTML = recentScores.map(score => {
      const date = new Date(score.createdAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      return `<div class="recent-score-item">
        <span class="recent-score-title">${escapeHtml(score.title)}</span>
        <span class="recent-score-date">${date}</span>
      </div>`;
    }).join('');
  }
  
  document.getElementById('profile-modal').classList.add('show');
}

function closeProfileModal() {
  document.getElementById('profile-modal').classList.remove('show');
}

function capitalize(str) {
  return str.charAt(0).toUpperCase() + str.slice(1);
}

function formatNotation(notation) {
  const names = {
    'piano-roll': 'Piano Roll',
    'treble-bass': 'Treble/Bass',
    'ssaattbb': 'SSAATTBB',
    'lead-sheet': 'Lead Sheet'
  };
  return names[notation] || notation;
}

// ==================== USER SETTINGS ====================
function showSettingsModal() {
  const user = Storage.getCurrentUser();
  if (!user) {
    showToast('Please log in first', true);
    return;
  }
  
  // Load current display name
  document.getElementById('settings-display-name').value = user.displayName;
  
  // Clear password fields
  document.getElementById('settings-current-password').value = '';
  document.getElementById('settings-new-password').value = '';
  document.getElementById('settings-confirm-password').value = '';
  
  // Load user preferences
  loadUserPreferences();
  
  // Setup theme options
  setupThemeOptions();
  
  // Setup default dynamics options
  setupDefaultDynamicsOptions();
  
  document.getElementById('settings-modal').classList.add('show');
}

function closeSettingsModal() {
  document.getElementById('settings-modal').classList.remove('show');
}

function switchSettingsTab(tab) {
  document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.settings-tab-content').forEach(c => c.classList.remove('active'));
  document.querySelector(`.settings-tab[data-tab="${tab}"]`).classList.add('active');
  document.getElementById(`settings-${tab}-tab`).classList.add('active');
}

function updateDisplayName() {
  const user = Storage.getCurrentUser();
  if (!user) return;
  
  const newName = document.getElementById('settings-display-name').value.trim();
  if (!newName) {
    showToast('Display name cannot be empty', true);
    return;
  }
  
  const users = Storage.getUsers();
  users[user.username].displayName = newName;
  localStorage.setItem(Storage.KEYS.USERS, JSON.stringify(users));
  
  updateUserUI();
  showToast('Display name updated!');
}

function updatePassword() {
  const user = Storage.getCurrentUser();
  if (!user) return;
  
  const currentPass = document.getElementById('settings-current-password').value;
  const newPass = document.getElementById('settings-new-password').value;
  const confirmPass = document.getElementById('settings-confirm-password').value;
  
  if (!currentPass || !newPass || !confirmPass) {
    showToast('Please fill in all password fields', true);
    return;
  }
  
  const users = Storage.getUsers();
  if (users[user.username].password !== currentPass) {
    showToast('Current password is incorrect', true);
    return;
  }
  
  if (newPass.length < 6) {
    showToast('New password must be at least 6 characters', true);
    return;
  }
  
  if (newPass !== confirmPass) {
    showToast('New passwords do not match', true);
    return;
  }
  
  users[user.username].password = newPass;
  localStorage.setItem(Storage.KEYS.USERS, JSON.stringify(users));
  
  // Clear fields
  document.getElementById('settings-current-password').value = '';
  document.getElementById('settings-new-password').value = '';
  document.getElementById('settings-confirm-password').value = '';
  
  showToast('Password updated successfully!');
}

function deleteOwnAccount() {
  const user = Storage.getCurrentUser();
  if (!user) return;
  
  if (user.username === 'admin' || user.username === 'demo') {
    showToast('Cannot delete protected accounts', true);
    return;
  }
  
  const confirmText = prompt('Type your username to confirm deletion:');
  if (confirmText !== user.username) {
    showToast('Username does not match. Account not deleted.', true);
    return;
  }
  
  if (!confirm('‚ö†Ô∏è FINAL WARNING: This will permanently delete your account and all your scores. Continue?')) {
    return;
  }
  
  // Delete user's scores
  const scores = Storage.getAllScores();
  Object.keys(scores).forEach(scoreId => {
    if (scores[scoreId].userId === user.id) {
      delete scores[scoreId];
    }
  });
  localStorage.setItem(Storage.KEYS.SCORES, JSON.stringify(scores));
  
  // Delete user
  const users = Storage.getUsers();
  delete users[user.username];
  localStorage.setItem(Storage.KEYS.USERS, JSON.stringify(users));
  
  // Log out
  Storage.clearCurrentUser();
  closeSettingsModal();
  showScreen('landing');
  showToast('Account deleted');
}

// User Preferences
function getUserPreferences() {
  const user = Storage.getCurrentUser();
  if (!user) return {};
  
  const allPrefs = JSON.parse(localStorage.getItem('cosmos_user_preferences') || '{}');
  return allPrefs[user.id] || getDefaultPreferences();
}

function getDefaultPreferences() {
  return {
    theme: 'dark',
    showToasts: true,
    autoSave: false,
    compactCards: false,
    fontSize: '11',
    defaultNotation: 'piano-roll',
    defaultStyle: 'operatic',
    defaultKey: 'C',
    defaultTempo: '72',
    defaultTime: '4/4',
    defaultVoice: 'mezzo',
    defaultDynamics: ['traditional', 'vrn']
  };
}

function saveUserPreferences() {
  const user = Storage.getCurrentUser();
  if (!user) return;
  
  const prefs = {
    theme: document.querySelector('.theme-option.selected')?.dataset.theme || 'dark',
    showToasts: document.getElementById('pref-show-toasts')?.checked ?? true,
    autoSave: document.getElementById('pref-auto-save')?.checked ?? false,
    compactCards: document.getElementById('pref-compact-cards')?.checked ?? false,
    fontSize: document.getElementById('pref-font-size')?.value || '11',
    defaultNotation: document.getElementById('default-notation')?.value || 'piano-roll',
    defaultStyle: document.getElementById('default-style')?.value || 'operatic',
    defaultKey: document.getElementById('default-key')?.value || 'C',
    defaultTempo: document.getElementById('default-tempo')?.value || '72',
    defaultTime: document.getElementById('default-time')?.value || '4/4',
    defaultVoice: document.getElementById('default-voice')?.value || 'mezzo',
    defaultDynamics: getSelectedDefaultDynamics()
  };
  
  const allPrefs = JSON.parse(localStorage.getItem('cosmos_user_preferences') || '{}');
  allPrefs[user.id] = prefs;
  localStorage.setItem('cosmos_user_preferences', JSON.stringify(allPrefs));
  
  applyPreferences(prefs);
}

function loadUserPreferences() {
  const prefs = getUserPreferences();
  
  // Preferences tab
  document.getElementById('pref-show-toasts').checked = prefs.showToasts !== false;
  document.getElementById('pref-auto-save').checked = prefs.autoSave === true;
  document.getElementById('pref-compact-cards').checked = prefs.compactCards === true;
  document.getElementById('pref-font-size').value = prefs.fontSize || '11';
  
  // Defaults tab
  document.getElementById('default-notation').value = prefs.defaultNotation || 'piano-roll';
  document.getElementById('default-style').value = prefs.defaultStyle || 'operatic';
  document.getElementById('default-key').value = prefs.defaultKey || 'C';
  document.getElementById('default-tempo').value = prefs.defaultTempo || '72';
  document.getElementById('default-time').value = prefs.defaultTime || '4/4';
  document.getElementById('default-voice').value = prefs.defaultVoice || 'mezzo';
  
  // Theme
  document.querySelectorAll('.theme-option').forEach(opt => {
    opt.classList.toggle('selected', opt.dataset.theme === (prefs.theme || 'dark'));
  });
  
  // Default dynamics
  const defaultDynamics = prefs.defaultDynamics || ['traditional', 'vrn'];
  document.querySelectorAll('#default-dynamics-options .option-item').forEach(opt => {
    opt.classList.toggle('selected', defaultDynamics.includes(opt.dataset.value));
  });
}

function setupThemeOptions() {
  document.querySelectorAll('.theme-option').forEach(opt => {
    opt.onclick = function() {
      document.querySelectorAll('.theme-option').forEach(o => o.classList.remove('selected'));
      this.classList.add('selected');
      saveUserPreferences();
    };
  });
}

function setupDefaultDynamicsOptions() {
  document.querySelectorAll('#default-dynamics-options .option-item').forEach(opt => {
    opt.onclick = function() {
      this.classList.toggle('selected');
      saveUserPreferences();
    };
  });
}

function getSelectedDefaultDynamics() {
  return [...document.querySelectorAll('#default-dynamics-options .option-item.selected')].map(i => i.dataset.value);
}

function applyPreferences(prefs) {
  // Apply font size to score output
  const scoreOutput = document.getElementById('scoreOutput');
  if (scoreOutput && prefs.fontSize) {
    scoreOutput.style.fontSize = prefs.fontSize + 'px';
  }
  
  // Apply theme (CSS variable changes)
  applyTheme(prefs.theme || 'dark');
}

function applyTheme(theme) {
  const root = document.documentElement;
  
  if (theme === 'light') {
    root.style.setProperty('--bg-dark', '#f5f5f5');
    root.style.setProperty('--bg-card', '#ffffff');
    root.style.setProperty('--bg-input', '#e8e8e8');
    root.style.setProperty('--text-primary', '#1a1a1a');
    root.style.setProperty('--text-secondary', '#666666');
  } else if (theme === 'cosmic') {
    root.style.setProperty('--bg-dark', '#0d0618');
    root.style.setProperty('--bg-card', '#1a0a2e');
    root.style.setProperty('--bg-input', '#2a1048');
    root.style.setProperty('--text-primary', '#e8d4ff');
    root.style.setProperty('--text-secondary', '#a080c0');
  } else {
    // Dark (default)
    root.style.setProperty('--bg-dark', '#0a0a0f');
    root.style.setProperty('--bg-card', '#12121a');
    root.style.setProperty('--bg-input', '#1a1a24');
    root.style.setProperty('--text-primary', '#ffffff');
    root.style.setProperty('--text-secondary', '#a0a0b0');
  }
}

function resetDefaults() {
  if (!confirm('Reset all composition defaults to factory settings?')) return;
  
  document.getElementById('default-notation').value = 'piano-roll';
  document.getElementById('default-style').value = 'operatic';
  document.getElementById('default-key').value = 'C';
  document.getElementById('default-tempo').value = '72';
  document.getElementById('default-time').value = '4/4';
  document.getElementById('default-voice').value = 'mezzo';
  
  document.querySelectorAll('#default-dynamics-options .option-item').forEach(opt => {
    opt.classList.toggle('selected', ['traditional', 'vrn'].includes(opt.dataset.value));
  });
  
  saveUserPreferences();
  showToast('Defaults reset!');
}

function applyDefaultsToComposer() {
  const prefs = getUserPreferences();
  
  // Set notation
  document.querySelectorAll('#notationOptions .option-item').forEach(opt => {
    opt.classList.toggle('selected', opt.dataset.value === prefs.defaultNotation);
  });
  
  // Set style
  document.querySelectorAll('#styleOptions .option-item').forEach(opt => {
    opt.classList.toggle('selected', opt.dataset.value === prefs.defaultStyle);
  });
  
  // Set dynamics
  const defaultDynamics = prefs.defaultDynamics || ['traditional', 'vrn'];
  document.querySelectorAll('#dynamicsOptions .option-item').forEach(opt => {
    opt.classList.toggle('selected', defaultDynamics.includes(opt.dataset.value));
  });
  
  // Set selects
  document.getElementById('keySelect').value = prefs.defaultKey || 'C';
  document.getElementById('tempoSelect').value = prefs.defaultTempo || '72';
  document.getElementById('timeSelect').value = prefs.defaultTime || '4/4';
  document.getElementById('voiceSelect').value = prefs.defaultVoice || 'mezzo';
}

// ==================== CHANGE LOG ====================
function showChangelogModal() {
  document.getElementById('changelog-modal').classList.add('show');
}

function closeChangelogModal() {
  document.getElementById('changelog-modal').classList.remove('show');
}

// ==================== ADMIN PANEL ====================
function showAdminPanel() {
  const user = Storage.getCurrentUser();
  if (!user || !user.isAdmin) {
    showToast('Admin access required', true);
    return;
  }
  document.getElementById('admin-modal').classList.add('show');
  loadAdminStats();
  loadAdminUsers();
  loadAdminSettings();
}

function closeAdminPanel() {
  document.getElementById('admin-modal').classList.remove('show');
}

function switchAdminTab(tab) {
  document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.admin-tab-content').forEach(c => c.classList.remove('active'));
  document.querySelector(`.admin-tab[data-tab="${tab}"]`).classList.add('active');
  document.getElementById(`admin-${tab}-tab`).classList.add('active');
}

function loadAdminStats() {
  const users = Storage.getUsers();
  const scores = Storage.getAllScores();
  const userList = Object.values(users);
  
  document.getElementById('stat-total-users').textContent = userList.length;
  document.getElementById('stat-total-scores').textContent = Object.keys(scores).length;
  document.getElementById('stat-admin-users').textContent = userList.filter(u => u.isAdmin).length;
}

function loadAdminUsers() {
  const users = Storage.getUsers();
  const currentUser = Storage.getCurrentUser();
  const table = document.getElementById('users-table');
  
  let html = `<div class="user-row header">
    <div>Username</div>
    <div>Display Name</div>
    <div>Role</div>
    <div>Actions</div>
  </div>`;
  
  Object.values(users).forEach(user => {
    const isProtected = user.username === 'admin' || user.username === 'demo';
    const isSelf = currentUser && user.username === currentUser.username;
    
    html += `<div class="user-row">
      <div class="user-name">@${escapeHtml(user.username)}</div>
      <div class="user-meta">${escapeHtml(user.displayName)}</div>
      <div><span class="user-badge ${user.isAdmin ? 'admin' : ''}">${user.isAdmin ? 'Admin' : 'User'}</span></div>
      <div>
        ${!isProtected && !isSelf ? `
          <button class="btn-small btn-secondary" onclick="toggleAdmin('${user.username}')">${user.isAdmin ? 'Remove Admin' : 'Make Admin'}</button>
          <button class="btn-small btn-danger" onclick="deleteUser('${user.username}')">Delete</button>
        ` : '<span style="color: var(--text-secondary); font-size: 0.8rem;">Protected</span>'}
      </div>
    </div>`;
  });
  
  table.innerHTML = html;
}

function toggleAdmin(username) {
  const users = Storage.getUsers();
  if (!users[username]) return;
  
  users[username].isAdmin = !users[username].isAdmin;
  localStorage.setItem(Storage.KEYS.USERS, JSON.stringify(users));
  
  loadAdminUsers();
  loadAdminStats();
  showToast(`${username} admin status updated`);
}

function deleteUser(username) {
  if (!confirm(`Delete user @${username}? This will also delete all their scores.`)) return;
  
  const users = Storage.getUsers();
  const scores = Storage.getAllScores();
  const userId = users[username]?.id;
  
  // Delete user's scores
  Object.keys(scores).forEach(scoreId => {
    if (scores[scoreId].userId === userId) {
      delete scores[scoreId];
    }
  });
  
  // Delete user
  delete users[username];
  
  localStorage.setItem(Storage.KEYS.USERS, JSON.stringify(users));
  localStorage.setItem(Storage.KEYS.SCORES, JSON.stringify(scores));
  
  loadAdminUsers();
  loadAdminStats();
  showToast(`User @${username} deleted`);
}

function loadAdminSettings() {
  const settings = Storage.getSettings();
  document.getElementById('setting-public-signup').checked = settings.allowPublicSignup !== false;
  document.getElementById('setting-max-scores').value = settings.maxScoresPerUser || 50;
  document.getElementById('setting-demo-mode').checked = settings.demoModeEnabled !== false;
  document.getElementById('setting-maintenance').checked = settings.maintenanceMode === true;
}

function saveSettings() {
  const settings = {
    allowPublicSignup: document.getElementById('setting-public-signup').checked,
    maxScoresPerUser: parseInt(document.getElementById('setting-max-scores').value) || 50,
    demoModeEnabled: document.getElementById('setting-demo-mode').checked,
    maintenanceMode: document.getElementById('setting-maintenance').checked
  };
  Storage.saveSettings(settings);
}

function exportAllData() {
  const data = {
    users: Storage.getUsers(),
    scores: Storage.getAllScores(),
    exportedAt: new Date().toISOString(),
    version: '1.0.0'
  };
  
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `cosmos-composer-backup-${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  
  showToast('Backup downloaded!');
}

function restoreData(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);
      
      if (!confirm('This will replace all existing data. Continue?')) return;
      
      if (data.users) localStorage.setItem(Storage.KEYS.USERS, JSON.stringify(data.users));
      if (data.scores) localStorage.setItem(Storage.KEYS.SCORES, JSON.stringify(data.scores));
      
      loadAdminUsers();
      loadAdminStats();
      showToast('Data restored successfully!');
    } catch (err) {
      showToast('Invalid backup file', true);
    }
  };
  reader.readAsText(file);
  event.target.value = ''; // Reset file input
}

function resetAllData() {
  const adminPass = prompt('Enter admin password to confirm reset:');
  if (adminPass !== 'admin123') {
    showToast('Incorrect admin password', true);
    return;
  }
  
  if (!confirm('‚ö†Ô∏è FINAL WARNING: This will delete ALL users and scores. This cannot be undone!')) return;
  
  localStorage.removeItem(Storage.KEYS.USERS);
  localStorage.removeItem(Storage.KEYS.SCORES);
  localStorage.removeItem(Storage.KEYS.CURRENT_USER);
  
  Storage.init();
  closeAdminPanel();
  showScreen('landing');
  showToast('All data has been reset');
}

// ==================== INIT ====================
window.onload = function() {
  const user = Storage.getCurrentUser();
  if (user) {
    showScreen('dashboard');
    updateUserUI();
    // Apply saved preferences
    const prefs = getUserPreferences();
    applyPreferences(prefs);
  }
};

// Close modals on outside click
document.addEventListener('click', (e) => {
  if (e.target.id === 'profile-modal') closeProfileModal();
  if (e.target.id === 'settings-modal') closeSettingsModal();
  if (e.target.id === 'changelog-modal') closeChangelogModal();
});

// ==================== LANDING PAGE COMPOSER ====================
let landingGeneratedScore = '';

function setupLandingPageOptions() {
  // Setup notation options
  document.querySelectorAll('#landingNotationOptions .option-item').forEach(option => {
    option.addEventListener('click', () => {
      document.querySelectorAll('#landingNotationOptions .option-item').forEach(o => o.classList.remove('selected'));
      option.classList.add('selected');
    });
  });
  
  // Setup style options
  document.querySelectorAll('#landingStyleOptions .option-item').forEach(option => {
    option.addEventListener('click', () => {
      document.querySelectorAll('#landingStyleOptions .option-item').forEach(o => o.classList.remove('selected'));
      option.classList.add('selected');
    });
  });
}

function generateLandingScore() {
  const lyrics = document.getElementById('landingLyricsInput').value.trim();
  
  if (!lyrics) {
    showToast('Please enter some lyrics first', true);
    return;
  }
  
  const notation = document.querySelector('#landingNotationOptions .option-item.selected')?.dataset.value || 'piano-roll';
  const style = document.querySelector('#landingStyleOptions .option-item.selected')?.dataset.value || 'operatic';
  const key = document.getElementById('landingKeySelect').value;
  const voice = document.getElementById('landingVoiceSelect').value;
  
  // Use the main generateScore function but capture output for landing page
  const options = {
    lyrics,
    notation,
    style,
    key,
    voice,
    dynamics: ['traditional', 'vrn'],
    tempo: '72',
    time: '4/4'
  };
  
  landingGeneratedScore = generateScoreFromOptions(options);
  document.getElementById('landingScoreOutput').textContent = landingGeneratedScore;
  showToast('Score generated! Log in to save.');
}

function generateScoreFromOptions(options) {
  // Generate score based on options (reusing core generation logic)
  const lines = options.lyrics.split('\n').filter(l => l.trim());
  const voiceRanges = {
    soprano: { low: 'C4', high: 'C6', clef: 'treble' },
    mezzo: { low: 'A3', high: 'A5', clef: 'treble' },
    tenor: { low: 'C3', high: 'C5', clef: 'treble' },
    baritone: { low: 'A2', high: 'A4', clef: 'bass' }
  };
  
  const range = voiceRanges[options.voice] || voiceRanges.mezzo;
  const notes = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];
  const octaves = options.voice === 'soprano' ? [4, 5] : options.voice === 'baritone' ? [2, 3] : [3, 4];
  
  let output = '';
  
  // Header
  output += `‚îå${'‚îÄ'.repeat(60)}‚îê\n`;
  output += `‚îÇ  üéº COSMOS Composer - ${capitalize(options.style)} Style${' '.repeat(60 - 30 - options.style.length)}‚îÇ\n`;
  output += `‚îÇ  Key: ${options.key} | Tempo: ${options.tempo} BPM | Time: ${options.time}${' '.repeat(60 - 40)}‚îÇ\n`;
  output += `‚îÇ  Voice: ${capitalize(options.voice)} (${range.low}-${range.high})${' '.repeat(60 - 35 - options.voice.length)}‚îÇ\n`;
  output += `‚îî${'‚îÄ'.repeat(60)}‚îò\n\n`;
  
  if (options.notation === 'piano-roll') {
    output += generatePianoRoll(lines, notes, octaves, options);
  } else if (options.notation === 'treble-bass') {
    output += generateTrebleBass(lines, notes, octaves, options);
  } else if (options.notation === 'ssaattbb') {
    output += generateSSAATTBB(lines, notes, options);
  } else {
    output += generateLeadSheet(lines, notes, octaves, options);
  }
  
  return output;
}

function generatePianoRoll(lines, notes, octaves, options) {
  let output = '';
  const pitchLine = [];
  
  lines.forEach((line, lineIdx) => {
    const words = line.split(/\s+/);
    output += `\n‚ïê‚ïê‚ïê Line ${lineIdx + 1} ‚ïê‚ïê‚ïê\n`;
    
    words.forEach(word => {
      const syllables = word.match(/[^aeiou]*[aeiou]+[^aeiou]*/gi) || [word];
      syllables.forEach(syl => {
        const note = notes[Math.floor(Math.random() * notes.length)];
        const oct = octaves[Math.floor(Math.random() * octaves.length)];
        const vrn = getVRNCode(syl);
        const dynamic = getDynamic(lineIdx, lines.length);
        
        output += `  ${syl.padEnd(12)} ‚îÇ ${note}${oct} ${dynamic.padEnd(4)} [${vrn}]\n`;
      });
    });
  });
  
  return output;
}

function generateTrebleBass(lines, notes, octaves, options) {
  let output = 'TREBLE CLEF:\n';
  output += '‚îå' + '‚îÄ'.repeat(50) + '‚îê\n';
  
  lines.forEach((line, i) => {
    const note = notes[Math.floor(Math.random() * notes.length)];
    const oct = octaves[1] || octaves[0];
    output += `‚îÇ ${(i+1).toString().padStart(2)}. ${line.substring(0, 30).padEnd(30)} ${note}${oct} ‚îÇ\n`;
  });
  
  output += '‚îî' + '‚îÄ'.repeat(50) + '‚îò\n';
  return output;
}

function generateSSAATTBB(lines, notes, options) {
  let output = 'SSAATTBB CHORAL ARRANGEMENT:\n\n';
  const voices = ['S1', 'S2', 'A1', 'A2', 'T1', 'T2', 'B1', 'B2'];
  const voiceOctaves = [5, 5, 4, 4, 4, 3, 3, 2];
  
  lines.forEach((line, lineIdx) => {
    output += `Measure ${lineIdx + 1}: "${line}"\n`;
    output += '‚îÄ'.repeat(40) + '\n';
    
    voices.forEach((v, vi) => {
      const note = notes[Math.floor(Math.random() * notes.length)];
      output += `  ${v}: ${note}${voiceOctaves[vi]}\n`;
    });
    output += '\n';
  });
  
  return output;
}

function generateLeadSheet(lines, notes, octaves, options) {
  let output = 'LEAD SHEET:\n\n';
  const chords = ['Cmaj7', 'Dm7', 'Em7', 'Fmaj7', 'G7', 'Am7'];
  
  lines.forEach((line, i) => {
    const chord = chords[i % chords.length];
    output += `[${chord}]\n`;
    output += `  ${line}\n\n`;
  });
  
  return output;
}

function getVRNCode(syllable) {
  const vowel = syllable.match(/[aeiou]/i)?.[0]?.toLowerCase() || 'a';
  const codes = {
    a: 'OP-A', e: 'RS-E', i: 'CH-I', o: 'TH-O', u: 'NS-U'
  };
  return codes[vowel] || 'OP-A';
}

function getDynamic(lineIdx, totalLines) {
  const dynamics = ['pp', 'p', 'mp', 'mf', 'f', 'ff'];
  const midPoint = totalLines / 2;
  const idx = Math.min(Math.floor(Math.abs(lineIdx - midPoint) / midPoint * 3) + 2, 5);
  return dynamics[idx];
}

function copyLandingScore() {
  const output = document.getElementById('landingScoreOutput').textContent;
  if (!output || output.includes('Enter lyrics above')) {
    showToast('Generate a score first', true);
    return;
  }
  
  navigator.clipboard.writeText(output).then(() => {
    showToast('Score copied to clipboard!');
  }).catch(() => {
    showToast('Failed to copy', true);
  });
}

function downloadLandingScore() {
  const output = document.getElementById('landingScoreOutput').textContent;
  if (!output || output.includes('Enter lyrics above')) {
    showToast('Generate a score first', true);
    return;
  }
  
  const blob = new Blob([output], { type: 'text/plain' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `cosmos-score-${Date.now()}.txt`;
  a.click();
  
  showToast('Score downloaded!');
}

function promptLoginToSave() {
  const output = document.getElementById('landingScoreOutput').textContent;
  if (!output || output.includes('Enter lyrics above')) {
    showToast('Generate a score first', true);
    return;
  }
  
  // Store the score temporarily for after login
  sessionStorage.setItem('pendingScore', output);
  sessionStorage.setItem('pendingLyrics', document.getElementById('landingLyricsInput').value);
  
  showToast('Log in to save your score!');
  showScreen('auth');
}

// ==================== LANDING PAGE AUDIO PLAYBACK ====================
let landingAudioContext = null;
let landingMelody = [];
let landingIsPlaying = false;
let landingIsPaused = false;
let landingPlaybackIndex = 0;
let landingPlaybackTimeout = null;
let landingStartTime = 0;

function initLandingAudio() {
  if (!landingAudioContext) {
    landingAudioContext = new (window.AudioContext || window.webkitAudioContext)();
  }
  if (landingAudioContext.state === 'suspended') {
    landingAudioContext.resume();
  }
}

function playLandingNote(frequency, duration, startTime, volume = 0.3) {
  // Use voice presets
  playNoteWithVoices(landingAudioContext, frequency, duration, startTime, volume, landingSelectedVoices);
}

function generateLandingMelody(lyrics, voice, style) {
  const voiceRanges = {
    soprano: { scale: ['C4','D4','E4','F4','G4','A4','B4','C5','D5','E5','F5','G5','A5','B5','C6'] },
    mezzo: { scale: ['A3','B3','C4','D4','E4','F4','G4','A4','B4','C5','D5','E5','F5','G5','A5'] },
    tenor: { scale: ['C3','D3','E3','F3','G3','A3','B3','C4','D4','E4','F4','G4','A4','B4','C5'] },
    baritone: { scale: ['A2','B2','C3','D3','E3','F3','G3','A3','B3','C4','D4','E4','F4','G4','A4'] }
  };
  
  const stylePatterns = {
    operatic: { intervals: [2,3,4,5,7], dynamics: ['p','mp','mf','f','ff','fff'] },
    hypnotic: { intervals: [1,2,3], dynamics: ['p','mp','mf'] },
    trance: { intervals: [2,3,5], dynamics: ['p','mf','f','ff'] },
    classical: { intervals: [2,3,4,5], dynamics: ['p','mp','mf','f'] }
  };
  
  const range = voiceRanges[voice] || voiceRanges.mezzo;
  const pattern = stylePatterns[style] || stylePatterns.operatic;
  
  const words = [];
  lyrics.trim().split('\n').filter(l => l.trim()).forEach((line, lineIdx) => {
    line.trim().split(/\s+/).forEach((word, wordIdx, arr) => {
      if (word) words.push({ text: word.toLowerCase(), isLineStart: wordIdx === 0, isLineEnd: wordIdx === arr.length - 1, lineNum: lineIdx });
    });
  });
  
  const melody = [];
  let currentIdx = Math.floor(range.scale.length / 2);
  
  words.forEach((word, i) => {
    const progress = i / words.length;
    const emotion = progress > 0.7 ? 'powerful' : (progress < 0.3 ? 'tender' : 'building');
    const intensity = Math.ceil(progress * 3);
    let interval = pattern.intervals[Math.floor(Math.random() * pattern.intervals.length)];
    let direction = Math.random() > 0.5 ? 1 : -1;
    if (progress > 0.5) direction = 1;
    if (word.isLineStart && i > 0) currentIdx = Math.max(currentIdx - 2, 2);
    currentIdx = Math.max(0, Math.min(range.scale.length - 1, currentIdx + (direction * interval)));
    if (progress > 0.8 && progress < 0.9) currentIdx = Math.min(currentIdx + 3, range.scale.length - 2);
    
    const noteNum = parseInt(range.scale[currentIdx].slice(-1));
    let code = noteNum <= 3 ? 'C' : (noteNum === 4 ? 'M' : 'H');
    const vrn = `[${code}${'+'.repeat(Math.min(3, intensity))}]`;
    
    melody.push({
      word: word.text, 
      pitch: range.scale[currentIdx], 
      vrn: vrn,
      dynamic: pattern.dynamics[Math.min(Math.floor(progress * pattern.dynamics.length), pattern.dynamics.length - 1)],
      isLineStart: word.isLineStart, 
      isLineEnd: word.isLineEnd
    });
  });
  
  return melody;
}

function playLandingScore() {
  if (landingMelody.length === 0) {
    // Generate melody from current lyrics
    const lyrics = document.getElementById('landingLyricsInput').value.trim();
    if (!lyrics) {
      showToast('Generate a score first', true);
      return;
    }
    const voice = document.getElementById('landingVoiceSelect').value;
    const style = document.querySelector('#landingStyleOptions .option-item.selected')?.dataset.value || 'operatic';
    landingMelody = generateLandingMelody(lyrics, voice, style);
  }

  initLandingAudio();
  
  if (landingIsPaused) {
    landingIsPaused = false;
    landingIsPlaying = true;
    updateLandingPlaybackUI();
    playLandingFromIndex(landingPlaybackIndex);
    return;
  }

  stopLandingScore();
  landingIsPlaying = true;
  landingPlaybackIndex = 0;
  landingStartTime = Date.now();
  
  document.getElementById('landingPlaybackProgress').style.display = 'block';
  updateLandingPlaybackUI();
  playLandingFromIndex(0);
}

function playLandingFromIndex(index) {
  if (!landingIsPlaying || index >= landingMelody.length) {
    if (index >= landingMelody.length) {
      if (landingLoopEnabled) {
        // Loop back to beginning
        landingPlaybackIndex = 0;
        landingStartTime = Date.now();
        showToast('Looping...');
        playLandingFromIndex(0);
        return;
      }
      stopLandingScore();
      showToast('Playback complete');
    }
    return;
  }

  const note = landingMelody[index];
  const tempo = 72; // Default tempo for landing page
  const beatDuration = 60 / tempo;
  const noteDuration = beatDuration * 0.8;
  
  const freq = noteFrequencies[note.pitch];
  if (freq) {
    const dynamicVolumes = { 'ppp': 0.1, 'pp': 0.15, 'p': 0.2, 'mp': 0.25, 'mf': 0.3, 'f': 0.4, 'ff': 0.5, 'fff': 0.6 };
    const volume = dynamicVolumes[note.dynamic] || 0.3;
    playLandingNote(freq, noteDuration, landingAudioContext.currentTime, volume);
  }

  landingPlaybackIndex = index;
  updateLandingProgressUI(index, landingMelody.length, note);

  const nextDelay = beatDuration * 1000;
  landingPlaybackTimeout = setTimeout(() => {
    playLandingFromIndex(index + 1);
  }, nextDelay);
}

function pauseLandingScore() {
  if (landingIsPlaying && !landingIsPaused) {
    landingIsPaused = true;
    landingIsPlaying = false;
    if (landingPlaybackTimeout) {
      clearTimeout(landingPlaybackTimeout);
      landingPlaybackTimeout = null;
    }
    updateLandingPlaybackUI();
    showToast('Paused');
  }
}

function stopLandingScore() {
  landingIsPlaying = false;
  landingIsPaused = false;
  landingPlaybackIndex = 0;
  
  if (landingPlaybackTimeout) {
    clearTimeout(landingPlaybackTimeout);
    landingPlaybackTimeout = null;
  }
  
  document.getElementById('landingProgressBar').style.width = '0%';
  document.getElementById('landingCurrentNote').textContent = 'Ready';
  document.getElementById('landingPlaybackTime').textContent = '0:00';
  updateLandingPlaybackUI();
}

function updateLandingPlaybackUI() {
  const playBtn = document.getElementById('landingPlayBtn');
  const pauseBtn = document.getElementById('landingPauseBtn');
  const stopBtn = document.getElementById('landingStopBtn');
  
  if (landingIsPlaying) {
    playBtn.style.display = 'none';
    pauseBtn.style.display = 'inline-block';
    stopBtn.style.background = 'rgba(255,107,157,0.3)';
  } else if (landingIsPaused) {
    playBtn.innerHTML = '‚ñ∂Ô∏è Resume';
    playBtn.style.display = 'inline-block';
    pauseBtn.style.display = 'none';
    stopBtn.style.background = '';
  } else {
    playBtn.innerHTML = '‚ñ∂Ô∏è Play';
    playBtn.style.display = 'inline-block';
    pauseBtn.style.display = 'none';
    stopBtn.style.background = '';
  }
}

function updateLandingProgressUI(current, total, note) {
  const progress = ((current + 1) / total) * 100;
  document.getElementById('landingProgressBar').style.width = progress + '%';
  document.getElementById('landingCurrentNote').textContent = `‚ô™ ${note.pitch} - "${note.word}" ${note.vrn}`;
  
  const elapsed = Math.floor((Date.now() - landingStartTime) / 1000);
  const mins = Math.floor(elapsed / 60);
  const secs = elapsed % 60;
  document.getElementById('landingPlaybackTime').textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
}

// Update generateLandingScore to store melody for playback
const originalGenerateLandingScore = generateLandingScore;
generateLandingScore = function() {
  const lyrics = document.getElementById('landingLyricsInput').value.trim();
  
  if (!lyrics) {
    showToast('Please enter some lyrics first', true);
    return;
  }
  
  const notation = document.querySelector('#landingNotationOptions .option-item.selected')?.dataset.value || 'piano-roll';
  const style = document.querySelector('#landingStyleOptions .option-item.selected')?.dataset.value || 'operatic';
  const key = document.getElementById('landingKeySelect').value;
  const voice = document.getElementById('landingVoiceSelect').value;
  
  // Generate melody for playback
  landingMelody = generateLandingMelody(lyrics, voice, style);
  
  const options = {
    lyrics,
    notation,
    style,
    key,
    voice,
    dynamics: ['traditional', 'vrn'],
    tempo: '72',
    time: '4/4'
  };
  
  landingGeneratedScore = generateScoreFromOptions(options);
  document.getElementById('landingScoreOutput').textContent = landingGeneratedScore;
  
  // Reset and show playback
  stopLandingScore();
  document.getElementById('landingPlaybackProgress').style.display = 'block';
  document.getElementById('landingCurrentNote').textContent = `Ready - ${landingMelody.length} notes`;
  
  showToast('Score generated! Click Play to hear it.');
};

// ==================== VOICE PRESETS ====================
const voicePresets = {
  pure: { type: 'sine', harmonics: [1, 0, 0], attack: 0.05, decay: 0.1, sustain: 0.7, release: 0.2 },
  choir: { type: 'triangle', harmonics: [1, 0.5, 0.25], attack: 0.1, decay: 0.15, sustain: 0.6, release: 0.3 },
  organ: { type: 'square', harmonics: [1, 0.3, 0.1], attack: 0.02, decay: 0.05, sustain: 0.8, release: 0.1 },
  strings: { type: 'sawtooth', harmonics: [1, 0.7, 0.4], attack: 0.15, decay: 0.2, sustain: 0.5, release: 0.4 },
  rich: { type: 'sine', harmonics: [1, 0.6, 0.3, 0.15], attack: 0.08, decay: 0.12, sustain: 0.65, release: 0.25 }
};

// Landing page voice and loop state
let landingSelectedVoices = ['pure'];
let landingLoopEnabled = false;

// Main composer voice and loop state
let selectedVoices = ['pure'];
let loopEnabled = false;

function getSelectedVoices(containerId) {
  const container = document.getElementById(containerId);
  if (!container) return ['pure'];
  const checkboxes = container.querySelectorAll('input[type="checkbox"]:checked');
  return Array.from(checkboxes).map(cb => cb.value);
}

function changeLandingVoice() {
  landingSelectedVoices = getSelectedVoices('landingVoiceOptions');
  if (landingSelectedVoices.length === 0) landingSelectedVoices = ['pure'];
}

function changeVoice() {
  selectedVoices = getSelectedVoices('voiceOptions');
  if (selectedVoices.length === 0) selectedVoices = ['pure'];
}

function toggleLandingLoop() {
  landingLoopEnabled = !landingLoopEnabled;
  const btn = document.getElementById('landingLoopBtn');
  if (landingLoopEnabled) {
    btn.classList.add('active');
    btn.innerHTML = '\u21bb Loop On';
    showToast('Loop enabled');
  } else {
    btn.classList.remove('active');
    btn.innerHTML = '\u21bb Loop';
    showToast('Loop disabled');
  }
}

function toggleLoop() {
  loopEnabled = !loopEnabled;
  const btn = document.getElementById('loopBtn');
  if (loopEnabled) {
    btn.classList.add('active');
    btn.innerHTML = '\u21bb Loop On';
    showToast('Loop enabled');
  } else {
    btn.classList.remove('active');
    btn.innerHTML = '\u21bb Loop';
    showToast('Loop disabled');
  }
}

// Enhanced note playback with voice presets
function playNoteWithVoices(audioContext, frequency, duration, startTime, volume, voices) {
  voices.forEach(voiceName => {
    const preset = voicePresets[voiceName] || voicePresets.pure;
    const gainNode = audioContext.createGain();
    
    preset.harmonics.forEach((harmonic, i) => {
      if (harmonic <= 0) return;
      const osc = audioContext.createOscillator();
      osc.type = preset.type;
      osc.frequency.setValueAtTime(frequency * (i + 1), startTime);
      
      const oscGain = audioContext.createGain();
      oscGain.gain.setValueAtTime(harmonic * volume / voices.length, startTime);
      
      osc.connect(oscGain);
      oscGain.connect(gainNode);
      osc.start(startTime);
      osc.stop(startTime + duration);
    });
    
    // ADSR envelope
    gainNode.gain.setValueAtTime(0, startTime);
    gainNode.gain.linearRampToValueAtTime(volume / voices.length, startTime + preset.attack);
    gainNode.gain.linearRampToValueAtTime(volume * preset.sustain / voices.length, startTime + preset.attack + preset.decay);
    gainNode.gain.setValueAtTime(volume * preset.sustain / voices.length, startTime + duration - preset.release);
    gainNode.gain.linearRampToValueAtTime(0, startTime + duration);
    
    gainNode.connect(audioContext.destination);
  });
}

// Initialize landing page options on load
document.addEventListener('DOMContentLoaded', function() {
  setupLandingPageOptions();
});
  </script>
</body>
</html>
